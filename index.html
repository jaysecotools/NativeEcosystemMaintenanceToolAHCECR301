<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Native Ecosystem Maintenance Tool | AHCECR301 Compliance</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- FullCalendar CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- ADD MISSING LIBRARIES -->
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.2/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
            --dark-text: #212529;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            overflow-x: hidden;
        }
        
        /* Sidebar Styles */
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            margin: 0.25rem 1rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .sidebar .nav-link i {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }
        
        .logo {
            font-weight: 700;
            padding: 1.5rem;
            font-size: 1.3rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
            letter-spacing: 1px;
        }
        
        /* Main Content */
        .main-content {
            background-color: var(--light-bg);
            padding: 2rem;
            min-height: 100vh;
        }
        
        /* Cards */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            height: 100%;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .card-title {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--accent-color);
        }
        
        /* Dashboard Stats */
        .dashboard-stat {
            text-align: center;
            padding: 1.5rem;
            border-radius: 12px;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .dashboard-stat h3 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .dashboard-stat p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .dashboard-stat i {
            position: absolute;
            right: 1rem;
            bottom: 1rem;
            font-size: 3rem;
            opacity: 0.2;
        }
        
        .stat-tasks { background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); }
        .stat-assessments { background: linear-gradient(135deg, var(--success-color), #2ecc71); }
        .stat-species { background: linear-gradient(135deg, var(--warning-color), #f1c40f); }
        .stat-compliance { background: linear-gradient(135deg, var(--danger-color), #e67e22); }
        
        /* Map Container */
        .map-container {
            height: 400px;
            background-color: #e9ecef;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        
        #map {
            height: 100%;
            width: 100%;
            border-radius: 8px;
        }
        
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .map-controls .btn-group {
            margin: 5px;
        }
        
        .map-controls .btn {
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
        }
        
        .toast {
            min-width: 250px;
        }
        
        /* Badges */
        .risk-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .risk-low { background-color: var(--success-color); }
        .risk-medium { background-color: var(--warning-color); }
        .risk-high { background-color: var(--danger-color); }
        
        .badge {
            padding: 0.5rem 0.75rem;
            font-weight: 500;
        }
        
        /* Species Cards */
        .species-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .species-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .species-card img {
            height: 200px;
            object-fit: cover;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        
        /* Image Previews */
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .image-thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            transition: all 0.2s ease;
        }
        
        .image-thumbnail:hover {
            transform: scale(1.05);
            border-color: var(--accent-color);
        }
        
        .species-image-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 8px;
            display: none;
        }
        
        /* Calendar */
        .fc-event {
            cursor: pointer;
            border-radius: 4px !important;
            border: none !important;
        }
        
        .fc-event-title {
            white-space: normal;
            font-weight: 500;
            padding: 2px 4px;
        }
        
        .fc-daygrid-event-dot {
            display: none;
        }
        
        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: #dee2e6;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .loading-spinner.show {
            display: block;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.875rem;
        }
        
        /* Forms */
        .form-control:focus,
        .form-select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        
        .form-control.is-invalid,
        .form-select.is-invalid {
            background-image: none;
        }
        
        .invalid-feedback {
            font-size: 0.875rem;
        }
        
        /* Tables */
        .table-responsive {
            overflow-x: auto;
            border-radius: 8px;
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .table thead th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
            border: none;
            padding: 0.75rem;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        /* Progress Bar */
        .progress {
            height: 10px;
            border-radius: 5px;
            background-color: #e9ecef;
        }
        
        .progress-bar {
            background-color: var(--success-color);
            border-radius: 5px;
        }
        
        /* Accordion */
        .accordion-button:not(.collapsed) {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
        }
        
        .accordion-button:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        
        /* Modal */
        .modal-content {
            border: none;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 12px 12px 0 0;
            padding: 1.5rem;
        }
        
        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            border-top: 1px solid #dee2e6;
            padding: 1.5rem;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                min-height: auto;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .dashboard-stat h3 {
                font-size: 1.8rem;
            }
            
            .map-container {
                height: 300px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .table thead {
                display: none;
            }
            
            .table tbody tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #dee2e6;
                border-radius: 8px;
            }
            
            .table tbody td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem;
                border: none;
                border-bottom: 1px solid #dee2e6;
            }
            
            .table tbody td:last-child {
                border-bottom: none;
            }
            
            .table tbody td::before {
                content: attr(data-label);
                font-weight: 600;
                margin-right: 1rem;
            }
        }
        
        /* Print Styles */
        @media print {
            .sidebar,
            .map-controls,
            .btn-toolbar,
            .action-buttons,
            .modal-footer {
                display: none !important;
            }
            
            .main-content {
                padding: 0 !important;
            }
            
            .card {
                box-shadow: none !important;
                break-inside: avoid;
            }
        }
        
        /* Accessibility */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }
        
        .focus-visible:focus {
            outline: 3px solid var(--accent-color);
            outline-offset: 2px;
        }
        
        [role="button"] {
            cursor: pointer;
        }
        
        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease;
        }
    </style>
</head>

<body>
    <!-- Toast Notification Container -->
    <div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true"></div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 sidebar p-0" aria-label="Main Navigation">
                <div class="logo" role="banner">
                    <i class="bi bi-tree-fill me-2" aria-hidden="true"></i>
                    EcoMaintain
                </div>
                
                <ul class="nav flex-column p-3" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" 
                                data-bs-target="#dashboard" type="button" role="tab" 
                                aria-controls="dashboard" aria-selected="true">
                            <i class="bi bi-speedometer2" aria-hidden="true"></i>
                            <span>Dashboard</span>
                        </button>
                    </li>
                    
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="assessment-tab" data-bs-toggle="tab" 
                                data-bs-target="#site-assessment" type="button" role="tab" 
                                aria-controls="site-assessment" aria-selected="false">
                            <i class="bi bi-clipboard-data" aria-hidden="true"></i>
                            <span>Site Assessment</span>
                        </button>
                    </li>
                    
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="maintenance-tab" data-bs-toggle="tab" 
                                data-bs-target="#maintenance-plan" type="button" role="tab" 
                                aria-controls="maintenance-plan" aria-selected="false">
                            <i class="bi bi-calendar-check" aria-hidden="true"></i>
                            <span>Maintenance Plan</span>
                        </button>
                    </li>
                    
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="species-tab" data-bs-toggle="tab" 
                                data-bs-target="#species-register" type="button" role="tab" 
                                aria-controls="species-register" aria-selected="false">
                            <i class="bi bi-tree" aria-hidden="true"></i>
                            <span>Species Register</span>
                        </button>
                    </li>
                    
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="monitoring-tab" data-bs-toggle="tab" 
                                data-bs-target="#monitoring" type="button" role="tab" 
                                aria-controls="monitoring" aria-selected="false">
                            <i class="bi bi-binoculars" aria-hidden="true"></i>
                            <span>Monitoring</span>
                        </button>
                    </li>
                    
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="reports-tab" data-bs-toggle="tab" 
                                data-bs-target="#reports" type="button" role="tab" 
                                aria-controls="reports" aria-selected="false">
                            <i class="bi bi-file-earmark-text" aria-hidden="true"></i>
                            <span>Reports</span>
                        </button>
                    </li>
                    
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="legislation-tab" data-bs-toggle="tab" 
                                data-bs-target="#legislation" type="button" role="tab" 
                                aria-controls="legislation" aria-selected="false">
                            <i class="bi bi-journal-bookmark" aria-hidden="true"></i>
                            <span>Legislation</span>
                        </button>
                    </li>
                    <li class="nav-item">
    <a class="nav-link" href="UserGuide.html" target="_blank" 
       rel="noopener noreferrer" aria-label="User Guide (opens in new tab)">
        <i class="bi bi-question-circle" aria-hidden="true"></i>
        <span>User Guide</span>
        <i class="bi bi-box-arrow-up-right ms-auto" aria-hidden="true" style="font-size: 0.8rem;"></i>
    </a>
</li>
                    
                    <li class="nav-item mt-4" role="presentation">
                        <button class="nav-link" id="settings-tab" data-bs-toggle="tab" 
                                data-bs-target="#settings" type="button" role="tab" 
                                aria-controls="settings" aria-selected="false">
                            <i class="bi bi-gear" aria-hidden="true"></i>
                            <span>Settings</span>
                        </button>
                    </li>
                </ul>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 col-lg-10 ms-sm-auto main-content" id="mainContent">
                <div class="tab-content" id="mainTabContent">
                    <!-- Dashboard Tab -->
                    <div class="tab-pane fade show active" id="dashboard" role="tabpanel" 
                         aria-labelledby="dashboard-tab" tabindex="0">
                        
                        <header class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Native Ecosystem Maintenance Dashboard</h1>
                            
                            <div class="btn-toolbar mb-2 mb-md-0" role="toolbar" aria-label="Dashboard actions">
                                <div class="btn-group me-2" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" 
                                            id="exportDashboardBtn" aria-label="Export dashboard data">
                                        <i class="bi bi-download" aria-hidden="true"></i>
                                        Export
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" 
                                            id="printDashboardBtn" aria-label="Print dashboard">
                                        <i class="bi bi-printer" aria-hidden="true"></i>
                                        Print
                                    </button>
                                </div>
                                
                                <button type="button" class="btn btn-sm btn-success" 
                                        data-bs-toggle="modal" data-bs-target="#modalNewActivity"
                                        aria-label="Create new maintenance activity">
                                    <i class="bi bi-plus" aria-hidden="true"></i>
                                    New Activity
                                </button>
                            </div>
                        </header>

                        <!-- Dashboard Stats -->
                        <div class="row mb-4" role="region" aria-label="Dashboard statistics">
                            <div class="col-md-3 mb-3">
                                <div class="dashboard-stat stat-tasks">
                                    <h3 id="totalTasks" aria-live="polite">0</h3>
                                    <p>Upcoming Tasks</p>
                                    <i class="bi bi-list-task" aria-hidden="true"></i>
                                </div>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <div class="dashboard-stat stat-assessments">
                                    <h3 id="totalAssessments" aria-live="polite">0</h3>
                                    <p>Assessments</p>
                                    <i class="bi bi-clipboard-data" aria-hidden="true"></i>
                                </div>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <div class="dashboard-stat stat-species">
                                    <h3 id="totalSpecies" aria-live="polite">0</h3>
                                    <p>Species</p>
                                    <i class="bi bi-tree" aria-hidden="true"></i>
                                </div>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <div class="dashboard-stat stat-compliance">
                                    <h3 id="compliancePercent" aria-live="polite">0%</h3>
                                    <p>Compliance</p>
                                    <i class="bi bi-check-circle" aria-hidden="true"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Dashboard Widgets Row 1 -->
                        <div class="row mb-4">
                            <!-- Upcoming Tasks -->
                            <div class="col-md-4 mb-4">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="bi bi-calendar-event me-2" aria-hidden="true"></i>
                                            Upcoming Tasks
                                        </h5>
                                        
                                        <div class="loading-spinner" id="tasksLoadingSpinner" role="status">
                                            <div class="spinner-border text-primary" aria-hidden="true">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                        
                                        <div id="upcomingTasksList" class="list-group list-group-flush" 
                                             role="list" aria-label="Upcoming maintenance tasks">
                                            <!-- Tasks will be loaded here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Site Health Indicators -->
                            <div class="col-md-4 mb-4">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="bi bi-graph-up me-2" aria-hidden="true"></i>
                                            Site Health Indicators
                                        </h5>
                                        
                                        <canvas id="healthChart" height="200" role="img" 
                                                aria-label="Radar chart showing ecosystem health indicators"></canvas>
                                        
                                        <div id="healthIndicators" class="mt-3">
                                            <!-- Health indicators will be loaded here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Observations -->
                            <div class="col-md-4 mb-4">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="bi bi-binoculars me-2" aria-hidden="true"></i>
                                            Recent Observations
                                        </h5>
                                        
                                        <ul class="list-group list-group-flush" id="recentObservationsList"
                                            role="list" aria-label="Recent monitoring observations">
                                            <!-- Observations will be loaded here -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Dashboard Widgets Row 2 -->
                        <div class="row">
                            <!-- Site Map -->
                            <div class="col-md-8 mb-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="bi bi-map me-2" aria-hidden="true"></i>
                                            Site Map
                                        </h5>
                                        
                                        <div class="map-container" role="region" aria-label="Interactive site map">
                                            <div id="map"></div>
                                            
                                            <div class="map-controls" role="group" aria-label="Map layer controls">
                                                <div class="btn-group-vertical">
                                                    <button id="zoneToggle" class="btn btn-sm btn-outline-primary active" 
                                                            aria-pressed="true" aria-label="Toggle zones layer">
                                                        Zones
                                                    </button>
                                                    <button id="vegetationToggle" class="btn btn-sm btn-outline-success" 
                                                            aria-pressed="false" aria-label="Toggle vegetation layer">
                                                        Vegetation
                                                    </button>
                                                    <button id="weedsToggle" class="btn btn-sm btn-outline-danger" 
                                                            aria-pressed="false" aria-label="Toggle weeds layer">
                                                        Weeds
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Compliance Checklist -->
                            <div class="col-md-4 mb-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="bi bi-check2-square me-2" aria-hidden="true"></i>
                                            Compliance Checklist
                                        </h5>
                                        
                                        <div id="dashboardComplianceChecklist" role="list" aria-label="Compliance items">
                                            <!-- Checklist will be loaded here -->
                                        </div>
                                        
                                        <div class="progress mt-3" role="progressbar" 
                                             aria-label="Compliance progress" aria-valuemin="0" aria-valuemax="100">
                                            <div class="progress-bar bg-success" id="complianceProgress" 
                                                 style="width: 0%;" aria-valuenow="0">
                                                0% Complete
                                            </div>
                                        </div>
                                        
                                        <button class="btn btn-sm btn-primary mt-3 w-100" 
                                                id="generateComplianceReportBtn"
                                                aria-label="Generate compliance report">
                                            <i class="bi bi-file-earmark-pdf me-2" aria-hidden="true"></i>
                                            Generate Compliance Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Site Assessment Tab -->
                    <div class="tab-pane fade" id="site-assessment" role="tabpanel" 
                         aria-labelledby="assessment-tab" tabindex="0">
                        
                        <header class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Site Assessment</h1>
                            
                            <button type="button" class="btn btn-sm btn-success" 
                                    data-bs-toggle="modal" data-bs-target="#modalNewAssessment"
                                    aria-label="Create new site assessment">
                                <i class="bi bi-plus" aria-hidden="true"></i>
                                New Assessment
                            </button>
                        </header>

                        <!-- Previous Assessments Table -->
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Previous Assessments</h5>
                                
                                <div class="loading-spinner" id="assessmentsLoadingSpinner" role="status">
                                    <div class="spinner-border text-primary" aria-hidden="true">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="assessmentsTable" 
                                           aria-label="Previous site assessments">
                                        <thead>
                                            <tr>
                                                <th scope="col">Date</th>
                                                <th scope="col">Assessor</th>
                                                <th scope="col">Health Rating</th>
                                                <th scope="col">Main Threats</th>
                                                <th scope="col">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Assessments will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Maintenance Plan Tab -->
                    <div class="tab-pane fade" id="maintenance-plan" role="tabpanel" 
                         aria-labelledby="maintenance-tab" tabindex="0">
                        
                        <header class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Maintenance Plan</h1>
                            
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <button type="button" class="btn btn-sm btn-success" 
                                        data-bs-toggle="modal" data-bs-target="#modalNewActivity"
                                        aria-label="Create new maintenance activity">
                                    <i class="bi bi-plus" aria-hidden="true"></i>
                                    New Activity
                                </button>
                            </div>
                        </header>

                        <!-- Maintenance Activities Tabs -->
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Maintenance Activities</h5>
                                
                                <ul class="nav nav-tabs" id="maintenanceTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="upcoming-tab" 
                                                data-bs-toggle="tab" data-bs-target="#upcoming" 
                                                type="button" role="tab" aria-controls="upcoming" 
                                                aria-selected="true">
                                            Upcoming
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="completed-tab" 
                                                data-bs-toggle="tab" data-bs-target="#completed" 
                                                type="button" role="tab" aria-controls="completed" 
                                                aria-selected="false">
                                            Completed
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="overdue-tab" 
                                                data-bs-toggle="tab" data-bs-target="#overdue" 
                                                type="button" role="tab" aria-controls="overdue" 
                                                aria-selected="false">
                                            Overdue
                                        </button>
                                    </li>
                                </ul>
                                
                                <div class="tab-content p-3 border border-top-0 rounded-bottom">
                                    <!-- Upcoming Activities -->
                                    <div class="tab-pane fade show active" id="upcoming" 
                                         role="tabpanel" aria-labelledby="upcoming-tab" tabindex="0">
                                        
                                        <div class="loading-spinner" id="upcomingActivitiesLoadingSpinner" role="status">
                                            <div class="spinner-border text-primary" aria-hidden="true">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                        
                                        <div class="table-responsive">
                                            <table class="table table-hover" id="upcomingActivitiesTable"
                                                   aria-label="Upcoming maintenance activities">
                                                <thead>
                                                    <tr>
                                                        <th scope="col">Activity</th>
                                                        <th scope="col">Type</th>
                                                        <th scope="col">Scheduled</th>
                                                        <th scope="col">Location</th>
                                                        <th scope="col">Assigned To</th>
                                                        <th scope="col">Status</th>
                                                        <th scope="col">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- Activities will be loaded here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Completed Activities -->
                                    <div class="tab-pane fade" id="completed" 
                                         role="tabpanel" aria-labelledby="completed-tab" tabindex="0">
                                        
                                        <div class="loading-spinner" id="completedActivitiesLoadingSpinner" role="status">
                                            <div class="spinner-border text-primary" aria-hidden="true">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                        
                                        <div class="table-responsive">
                                            <table class="table table-hover" id="completedActivitiesTable"
                                                   aria-label="Completed maintenance activities">
                                                <thead>
                                                    <tr>
                                                        <th scope="col">Activity</th>
                                                        <th scope="col">Type</th>
                                                        <th scope="col">Completed</th>
                                                        <th scope="col">Location</th>
                                                        <th scope="col">Assigned To</th>
                                                        <th scope="col">Status</th>
                                                        <th scope="col">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- Activities will be loaded here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Overdue Activities -->
                                    <div class="tab-pane fade" id="overdue" 
                                         role="tabpanel" aria-labelledby="overdue-tab" tabindex="0">
                                        
                                        <div class="loading-spinner" id="overdueActivitiesLoadingSpinner" role="status">
                                            <div class="spinner-border text-primary" aria-hidden="true">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                        
                                        <div class="table-responsive">
                                            <table class="table table-hover" id="overdueActivitiesTable"
                                                   aria-label="Overdue maintenance activities">
                                                <thead>
                                                    <tr>
                                                        <th scope="col">Activity</th>
                                                        <th scope="col">Type</th>
                                                        <th scope="col">Due Date</th>
                                                        <th scope="col">Location</th>
                                                        <th scope="col">Assigned To</th>
                                                        <th scope="col">Status</th>
                                                        <th scope="col">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- Activities will be loaded here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Maintenance Calendar -->
                        <div class="card mt-4">
                            <div class="card-body">
                                <h5 class="card-title">Maintenance Calendar</h5>
                                <div id="calendar" style="min-height: 600px;" 
                                     role="region" aria-label="Maintenance activities calendar"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Species Register Tab -->
                    <div class="tab-pane fade" id="species-register" role="tabpanel" 
                         aria-labelledby="species-tab" tabindex="0">
                        
                        <header class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Species Register</h1>
                            
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <div class="btn-group me-2" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" 
                                            id="exportSpeciesBtn" aria-label="Export species data">
                                        <i class="bi bi-download" aria-hidden="true"></i>
                                        Export
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" 
                                            id="printSpeciesBtn" aria-label="Print species register">
                                        <i class="bi bi-printer" aria-hidden="true"></i>
                                        Print
                                    </button>
                                </div>
                                
                                <button type="button" class="btn btn-sm btn-success" 
                                        data-bs-toggle="modal" data-bs-target="#modalNewSpecies"
                                        aria-label="Add new species">
                                    <i class="bi bi-plus" aria-hidden="true"></i>
                                    New Species
                                </button>
                            </div>
                        </header>

                        <!-- Species Cards -->
                        <div class="row mb-4" id="speciesCardsContainer" 
                             role="list" aria-label="Recent species observations">
                            <!-- Species cards will be loaded here -->
                        </div>

                        <!-- Species Table -->
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Species List</h5>
                                
                                <div class="loading-spinner" id="speciesLoadingSpinner" role="status">
                                    <div class="spinner-border text-primary" aria-hidden="true">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="speciesTable"
                                           aria-label="Complete species register">
                                        <thead>
                                            <tr>
                                                <th scope="col">Scientific Name</th>
                                                <th scope="col">Common Name</th>
                                                <th scope="col">Type</th>
                                                <th scope="col">Status</th>
                                                <th scope="col">Last Observed</th>
                                                <th scope="col">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Species will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Monitoring Tab -->
                    <div class="tab-pane fade" id="monitoring" role="tabpanel" 
                         aria-labelledby="monitoring-tab" tabindex="0">
                        
                        <header class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Monitoring</h1>
                            
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <button type="button" class="btn btn-sm btn-success" 
                                        data-bs-toggle="modal" data-bs-target="#modalNewMonitoring"
                                        aria-label="Create new monitoring activity">
                                    <i class="bi bi-plus" aria-hidden="true"></i>
                                    New Monitoring
                                </button>
                            </div>
                        </header>

                        <!-- Monitoring Charts -->
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Fauna Monitoring</h5>
                                        <canvas id="faunaChart" height="200" 
                                                role="img" aria-label="Line chart of fauna sightings"></canvas>
                                        
                                        <div class="mt-3 d-flex gap-2">
                                            <button class="btn btn-sm btn-outline-primary" 
                                                    data-bs-toggle="modal" data-bs-target="#modalFaunaSighting"
                                                    aria-label="Add new fauna sighting">
                                                <i class="bi bi-plus-circle me-1" aria-hidden="true"></i>
                                                Add Sighting
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" 
                                                    id="viewAllFaunaBtn" aria-label="View all fauna records">
                                                View All
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">Vegetation Monitoring</h5>
                                        <canvas id="vegetationChart" height="200" 
                                                role="img" aria-label="Bar chart of vegetation coverage"></canvas>
                                        
                                        <div class="mt-3 d-flex gap-2">
                                            <button class="btn btn-sm btn-outline-primary" 
                                                    data-bs-toggle="modal" data-bs-target="#modalVegetationSurvey"
                                                    aria-label="Add new vegetation survey">
                                                <i class="bi bi-plus-circle me-1" aria-hidden="true"></i>
                                                Add Survey
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" 
                                                    id="viewAllVegetationBtn" aria-label="View all vegetation records">
                                                View All
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Monitoring Activities -->
                        <div class="card mt-2">
                            <div class="card-body">
                                <h5 class="card-title">Recent Monitoring Activities</h5>
                                
                                <div class="loading-spinner" id="monitoringLoadingSpinner" role="status">
                                    <div class="spinner-border text-primary" aria-hidden="true">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="monitoringTable"
                                           aria-label="Recent monitoring activities">
                                        <thead>
                                            <tr>
                                                <th scope="col">Date</th>
                                                <th scope="col">Type</th>
                                                <th scope="col">Location</th>
                                                <th scope="col">Observer</th>
                                                <th scope="col">Findings</th>
                                                <th scope="col">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Monitoring activities will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reports Tab -->
                    <div class="tab-pane fade" id="reports" role="tabpanel" 
                         aria-labelledby="reports-tab" tabindex="0">
                        
                        <header class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Reports</h1>
                            
                            <div class="btn-toolbar mb-2 mb-md-0">
                                <button type="button" class="btn btn-sm btn-primary" 
                                        data-bs-toggle="modal" data-bs-target="#modalGenerateReport"
                                        aria-label="Generate new report">
                                    <i class="bi bi-file-earmark-plus" aria-hidden="true"></i>
                                    Generate Report
                                </button>
                            </div>
                        </header>

                        <!-- Report Types -->
                        <div class="row">
                            <div class="col-md-4 mb-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="bi bi-shield-check me-2" aria-hidden="true"></i>
                                            Compliance Report
                                        </h5>
                                        <p class="card-text">Generate a report showing compliance with AHCECR301 requirements.</p>
                                        <button class="btn btn-primary" onclick="window.generateReport('compliance')">
                                            Generate
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="bi bi-tools me-2" aria-hidden="true"></i>
                                            Maintenance Summary
                                        </h5>
                                        <p class="card-text">Summary of all maintenance activities for a selected period.</p>
                                        <button class="btn btn-primary" onclick="window.generateReport('maintenance')">
                                            Generate
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="bi bi-binoculars me-2" aria-hidden="true"></i>
                                            Monitoring Summary
                                        </h5>
                                        <p class="card-text">Summary of monitoring activities and findings.</p>
                                        <button class="btn btn-primary" onclick="window.generateReport('monitoring')">
                                            Generate
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="bi bi-graph-up me-2" aria-hidden="true"></i>
                                            Ecosystem Health Trend
                                        </h5>
                                        <p class="card-text">Generate a trend report showing changes in ecosystem health over time.</p>
                                        <button class="btn btn-primary" onclick="window.generateReport('health-trend')">
                                            Generate
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="bi bi-exclamation-triangle me-2" aria-hidden="true"></i>
                                            Threat Management
                                        </h5>
                                        <p class="card-text">Report on threats and management actions taken.</p>
                                        <button class="btn btn-primary" onclick="window.generateReport('threat-management')">
                                            Generate
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Previous Reports -->
                        <div class="card mt-2">
                            <div class="card-body">
                                <h5 class="card-title">Previous Reports</h5>
                                
                                <div class="loading-spinner" id="reportsLoadingSpinner" role="status">
                                    <div class="spinner-border text-primary" aria-hidden="true">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="reportsTable"
                                           aria-label="Previously generated reports">
                                        <thead>
                                            <tr>
                                                <th scope="col">Date</th>
                                                <th scope="col">Report Type</th>
                                                <th scope="col">Generated By</th>
                                                <th scope="col">Period</th>
                                                <th scope="col">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Reports will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Legislation Tab -->
                    <div class="tab-pane fade" id="legislation" role="tabpanel" 
                         aria-labelledby="legislation-tab" tabindex="0">
                        
                        <header class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Legislation & Compliance</h1>
                        </header>

                        <!-- Legislation Accordion -->
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Relevant Legislation</h5>
                                
                                <div class="accordion" id="legislationAccordion">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button" type="button" 
                                                    data-bs-toggle="collapse" data-bs-target="#collapseOne"
                                                    aria-expanded="true" aria-controls="collapseOne">
                                                Environment Protection and Biodiversity Conservation Act 1999 (EPBC Act)
                                            </button>
                                        </h2>
                                        <div id="collapseOne" class="accordion-collapse collapse show" 
                                             data-bs-parent="#legislationAccordion">
                                            <div class="accordion-body">
                                                <p>The EPBC Act is the Australian Government's central piece of environmental legislation. It provides a legal framework to protect and manage nationally and internationally important flora, fauna, ecological communities and heritage places.</p>
                                                
                                                <p><strong>Key requirements:</strong></p>
                                                <ul>
                                                    <li>Identification and protection of threatened species and ecological communities</li>
                                                    <li>Regulation of actions that may impact matters of national environmental significance</li>
                                                    <li>Promotion of ecologically sustainable development</li>
                                                </ul>
                                                
                                                <a href="https://www.environment.gov.au/epbc" target="_blank" 
                                                   class="btn btn-sm btn-outline-primary" rel="noopener noreferrer">
                                                    More Information
                                                    <i class="bi bi-box-arrow-up-right ms-1" aria-hidden="true"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" 
                                                    data-bs-toggle="collapse" data-bs-target="#collapseTwo"
                                                    aria-expanded="false" aria-controls="collapseTwo">
                                                State/Territory Environmental Legislation
                                            </button>
                                        </h2>
                                        <div id="collapseTwo" class="accordion-collapse collapse" 
                                             data-bs-parent="#legislationAccordion">
                                            <div class="accordion-body">
                                                <p>Each state and territory has its own environmental protection and biodiversity conservation legislation that operates alongside the EPBC Act.</p>
                                                
                                                <div class="table-responsive">
                                                    <table class="table table-bordered">
                                                        <thead>
                                                            <tr>
                                                                <th>Jurisdiction</th>
                                                                <th>Primary Legislation</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr><td>NSW</td><td>Biodiversity Conservation Act 2016</td></tr>
                                                            <tr><td>VIC</td><td>Flora and Fauna Guarantee Act 1988</td></tr>
                                                            <tr><td>QLD</td><td>Nature Conservation Act 1992</td></tr>
                                                            <tr><td>WA</td><td>Biodiversity Conservation Act 2016</td></tr>
                                                            <tr><td>SA</td><td>National Parks and Wildlife Act 1972</td></tr>
                                                            <tr><td>TAS</td><td>Nature Conservation Act 2002</td></tr>
                                                            <tr><td>ACT</td><td>Nature Conservation Act 2014</td></tr>
                                                            <tr><td>NT</td><td>Territory Parks and Wildlife Conservation Act 2000</td></tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" 
                                                    data-bs-toggle="collapse" data-bs-target="#collapseThree"
                                                    aria-expanded="false" aria-controls="collapseThree">
                                                Local Government Regulations
                                            </button>
                                        </h2>
                                        <div id="collapseThree" class="accordion-collapse collapse" 
                                             data-bs-parent="#legislationAccordion">
                                            <div class="accordion-body">
                                                <p>Local governments often have additional planning schemes, local laws and policies that affect native ecosystem management.</p>
                                                
                                                <p><strong>Common local regulations include:</strong></p>
                                                <ul>
                                                    <li>Tree preservation orders</li>
                                                    <li>Vegetation clearing controls</li>
                                                    <li>Weed control requirements</li>
                                                    <li>Bushfire management provisions</li>
                                                </ul>
                                                
                                                <p>Check with your local council for specific requirements in your area.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Compliance Checklist -->
                        <div class="card mt-4">
                            <div class="card-body">
                                <h5 class="card-title">Compliance Checklist</h5>
                                <p>This checklist helps ensure your activities comply with relevant legislation and the requirements of AHCECR301.</p>
                                
                                <div class="loading-spinner" id="complianceLoadingSpinner" role="status">
                                    <div class="spinner-border text-primary" aria-hidden="true">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="complianceChecklistTable"
                                           aria-label="Compliance checklist items">
                                        <thead>
                                            <tr>
                                                <th scope="col">Requirement</th>
                                                <th scope="col">Compliant?</th>
                                                <th scope="col">Evidence</th>
                                                <th scope="col">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Compliance checklist will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <button class="btn btn-primary mt-3" id="saveComplianceBtn">
                                    <i class="bi bi-save me-2" aria-hidden="true"></i>
                                    Save Compliance Checklist
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Tab -->
                    <div class="tab-pane fade" id="settings" role="tabpanel" 
                         aria-labelledby="settings-tab" tabindex="0">
                        
                        <header class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                            <h1 class="h2">Settings</h1>
                        </header>

                        <div class="row">
                            <div class="col-md-6">
                                <!-- User Profile -->
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="bi bi-person-circle me-2" aria-hidden="true"></i>
                                            User Profile
                                        </h5>
                                        
                                        <form id="settingsUserProfileForm" novalidate>
                                            <div class="mb-3">
                                                <label for="settingsUserName" class="form-label">Full Name *</label>
                                                <input type="text" class="form-control" id="settingsUserName" required>
                                                <div class="invalid-feedback">Please provide your full name.</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="settingsUserEmail" class="form-label">Email *</label>
                                                <input type="email" class="form-control" id="settingsUserEmail" required>
                                                <div class="invalid-feedback">Please provide a valid email.</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="settingsUserRole" class="form-label">Role *</label>
                                                <select class="form-select" id="settingsUserRole" required>
                                                    <option value="" selected disabled>Select role...</option>
                                                    <option value="administrator">Administrator</option>
                                                    <option value="ecologist">Ecologist</option>
                                                    <option value="field-technician">Field Technician</option>
                                                    <option value="volunteer">Volunteer</option>
                                                </select>
                                                <div class="invalid-feedback">Please select a role.</div>
                                            </div>
                                            
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-check-circle me-2" aria-hidden="true"></i>
                                                Update Profile
                                            </button>
                                        </form>
                                    </div>
                                </div>

                                <!-- Site Settings -->
                                <div class="card mt-4">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="bi bi-geo-alt me-2" aria-hidden="true"></i>
                                            Site Settings
                                        </h5>
                                        
                                        <form id="settingsSiteForm" novalidate>
                                            <div class="mb-3">
                                                <label for="settingsSiteName" class="form-label">Site Name *</label>
                                                <input type="text" class="form-control" id="settingsSiteName" required>
                                                <div class="invalid-feedback">Please provide a site name.</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="settingsSiteLocation" class="form-label">Location *</label>
                                                <input type="text" class="form-control" id="settingsSiteLocation" required>
                                                <div class="invalid-feedback">Please provide the site location.</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="settingsSiteArea" class="form-label">Area (hectares) *</label>
                                                <input type="number" class="form-control" id="settingsSiteArea" 
                                                       required min="0" step="0.1">
                                                <div class="invalid-feedback">Please provide a valid area.</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="settingsSiteDescription" class="form-label">Description *</label>
                                                <textarea class="form-control" id="settingsSiteDescription" 
                                                          rows="3" required></textarea>
                                                <div class="invalid-feedback">Please provide a site description.</div>
                                            </div>
                                            
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-check-circle me-2" aria-hidden="true"></i>
                                                Update Site Details
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <!-- Change Password -->
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="bi bi-key me-2" aria-hidden="true"></i>
                                            Change Password
                                        </h5>
                                        
                                        <form id="settingsPasswordForm" novalidate>
                                            <div class="mb-3">
                                                <label for="settingsCurrentPassword" class="form-label">Current Password *</label>
                                                <input type="password" class="form-control" id="settingsCurrentPassword" required>
                                                <div class="invalid-feedback">Please enter your current password.</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="settingsNewPassword" class="form-label">New Password *</label>
                                                <input type="password" class="form-control" id="settingsNewPassword" 
                                                       required minlength="8">
                                                <div class="invalid-feedback">Password must be at least 8 characters.</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="settingsConfirmPassword" class="form-label">Confirm New Password *</label>
                                                <input type="password" class="form-control" id="settingsConfirmPassword" required>
                                                <div class="invalid-feedback">Passwords must match.</div>
                                            </div>
                                            
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-check-circle me-2" aria-hidden="true"></i>
                                                Change Password
                                            </button>
                                        </form>
                                    </div>
                                </div>

                                <!-- Data Management -->
                                <div class="card mt-4">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="bi bi-database me-2" aria-hidden="true"></i>
                                            Data Management
                                        </h5>
                                        
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-secondary" id="exportAllDataBtn">
                                                <i class="bi bi-download me-2" aria-hidden="true"></i>
                                                Export All Data
                                            </button>
                                            
                                            <button class="btn btn-outline-secondary" id="backupDatabaseBtn">
                                                <i class="bi bi-hdd-stack me-2" aria-hidden="true"></i>
                                                Backup Database
                                            </button>
                                            
                                            <button class="btn btn-outline-danger" id="resetTestDataBtn">
                                                <i class="bi bi-arrow-counterclockwise me-2" aria-hidden="true"></i>
                                                Reset Test Data
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- System Info -->
                                <div class="card mt-4">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="bi bi-info-circle me-2" aria-hidden="true"></i>
                                            System Information
                                        </h5>
                                        
                                        <dl class="row mb-0">
                                            <dt class="col-sm-5">Version</dt>
                                            <dd class="col-sm-7">1.0.0</dd>
                                            
                                            <dt class="col-sm-5">Last Backup</dt>
                                            <dd class="col-sm-7" id="lastBackupInfo">Never</dd>
                                            
                                            <dt class="col-sm-5">Storage Used</dt>
                                            <dd class="col-sm-7" id="storageUsed">Calculating...</dd>
                                            
                                            <dt class="col-sm-5">Records Count</dt>
                                            <dd class="col-sm-7" id="recordsCount">0</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- ============================ MODALS ============================ -->

    <!-- New Activity Modal -->
    <div class="modal fade" id="modalNewActivity" tabindex="-1" aria-labelledby="modalNewActivityLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalNewActivityLabel">
                        <i class="bi bi-plus-circle me-2" aria-hidden="true"></i>
                        New Maintenance Activity
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <form id="formNewActivity" novalidate>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="activityType" class="form-label">Activity Type *</label>
                                <select class="form-select" id="activityType" required>
                                    <option value="" selected disabled>Select type...</option>
                                    <option value="weed-control">Weed Control</option>
                                    <option value="revegetation">Revegetation</option>
                                    <option value="erosion-control">Erosion Control</option>
                                    <option value="fauna-survey">Fauna Survey</option>
                                    <option value="vegetation-survey">Vegetation Survey</option>
                                    <option value="water-quality">Water Quality Testing</option>
                                    <option value="other">Other</option>
                                </select>
                                <div class="invalid-feedback">Please select an activity type.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="activityTitle" class="form-label">Title *</label>
                                <input type="text" class="form-control" id="activityTitle" required maxlength="100">
                                <div class="invalid-feedback">Please provide a title.</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="activityStartDate" class="form-label">Start Date & Time *</label>
                                <input type="datetime-local" class="form-control" id="activityStartDate" required>
                                <div class="invalid-feedback">Please provide a start date.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="activityEndDate" class="form-label">End Date & Time</label>
                                <input type="datetime-local" class="form-control" id="activityEndDate">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="activityLocation" class="form-label">Location *</label>
                            <input type="text" class="form-control" id="activityLocation" required maxlength="200">
                            <div class="invalid-feedback">Please provide a location.</div>
                        </div>

                        <div class="mb-3">
                            <label for="activityDescription" class="form-label">Description *</label>
                            <textarea class="form-control" id="activityDescription" rows="3" required maxlength="1000"></textarea>
                            <div class="invalid-feedback">Please provide a description.</div>
                        </div>

                        <div class="mb-3">
                            <label for="activityAssignedTo" class="form-label">Assigned To *</label>
                            <input type="text" class="form-control" id="activityAssignedTo" required maxlength="100">
                            <div class="invalid-feedback">Please specify who this is assigned to.</div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="activityPriority" class="form-label">Priority</label>
                                <select class="form-select" id="activityPriority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="activityStatus" class="form-label">Status</label>
                                <select class="form-select" id="activityStatus">
                                    <option value="planned">Planned</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="activityNotes" class="form-label">Additional Notes</label>
                            <textarea class="form-control" id="activityNotes" rows="2" maxlength="500"></textarea>
                        </div>
                    </form>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2" aria-hidden="true"></i>
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="saveActivityBtn">
                        <i class="bi bi-check-circle me-2" aria-hidden="true"></i>
                        Save Activity
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Assessment Modal -->
    <div class="modal fade" id="modalNewAssessment" tabindex="-1" aria-labelledby="modalNewAssessmentLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalNewAssessmentLabel">
                        <i class="bi bi-clipboard-data me-2" aria-hidden="true"></i>
                        New Site Assessment
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <form id="formNewAssessment" novalidate>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="modalAssessmentDate" class="form-label">Assessment Date *</label>
                                <input type="date" class="form-control" id="modalAssessmentDate" required>
                                <div class="invalid-feedback">Please provide a valid date.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="modalAssessorName" class="form-label">Assessor Name *</label>
                                <input type="text" class="form-control" id="modalAssessorName" required maxlength="100">
                                <div class="invalid-feedback">Please provide the assessor's name.</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="modalSiteDescription" class="form-label">Site Description *</label>
                            <textarea class="form-control" id="modalSiteDescription" rows="3" required maxlength="2000"></textarea>
                            <div class="invalid-feedback">Please provide a site description.</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Ecosystem Components Present *</label>
                            <div class="row" id="componentsContainer">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="componentFlora" name="components" value="flora">
                                        <label class="form-check-label" for="componentFlora">Flora</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="componentFauna" name="components" value="fauna">
                                        <label class="form-check-label" for="componentFauna">Fauna</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="componentSoil" name="components" value="soil">
                                        <label class="form-check-label" for="componentSoil">Soil</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="componentWater" name="components" value="water">
                                        <label class="form-check-label" for="componentWater">Water</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="componentGeology" name="components" value="geology">
                                        <label class="form-check-label" for="componentGeology">Geology</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="componentClimate" name="components" value="climate">
                                        <label class="form-check-label" for="componentClimate">Climate</label>
                                    </div>
                                </div>
                            </div>
                            <div class="invalid-feedback" id="componentsFeedback" style="display: none;">Please select at least one component.</div>
                        </div>

                        <div class="mb-3">
                            <label for="modalEcosystemHealth" class="form-label">Ecosystem Health Assessment *</label>
                            <select class="form-select" id="modalEcosystemHealth" required>
                                <option value="" selected disabled>Select health rating...</option>
                                <option value="excellent">Excellent - Minimal disturbance</option>
                                <option value="good">Good - Some disturbance but recovering</option>
                                <option value="fair">Fair - Moderate disturbance</option>
                                <option value="poor">Poor - Significant disturbance</option>
                                <option value="degraded">Degraded - Severe disturbance</option>
                            </select>
                            <div class="invalid-feedback">Please select a health rating.</div>
                        </div>

                        <div class="mb-3">
                            <label for="modalThreats" class="form-label">Identified Threats</label>
                            <select class="form-select" id="modalThreats" multiple size="4">
                                <option value="weeds">Weeds</option>
                                <option value="pests">Pests</option>
                                <option value="erosion">Erosion</option>
                                <option value="fire">Fire</option>
                                <option value="climate">Climate change</option>
                                <option value="development">Development</option>
                                <option value="recreation">Recreational impacts</option>
                                <option value="grazing">Grazing</option>
                            </select>
                            <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                        </div>

                        <div class="mb-3">
                            <label for="modalAssessmentPhotos" class="form-label">Upload Photos</label>
                            <input class="form-control" type="file" id="modalAssessmentPhotos" multiple accept="image/*">
                            <div class="image-preview-container" id="assessmentPhotoPreview"></div>
                        </div>
                    </form>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2" aria-hidden="true"></i>
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="saveAssessmentBtn">
                        <i class="bi bi-check-circle me-2" aria-hidden="true"></i>
                        Save Assessment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Species Modal -->
    <div class="modal fade" id="modalNewSpecies" tabindex="-1" aria-labelledby="modalNewSpeciesLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalNewSpeciesLabel">
                        <i class="bi bi-tree me-2" aria-hidden="true"></i>
                        New Species Record
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <form id="formNewSpecies" novalidate>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="speciesScientificName" class="form-label">Scientific Name *</label>
                                <input type="text" class="form-control" id="speciesScientificName" required maxlength="200">
                                <div class="invalid-feedback">Please provide the scientific name.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="speciesCommonName" class="form-label">Common Name</label>
                                <input type="text" class="form-control" id="speciesCommonName" maxlength="200">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="speciesType" class="form-label">Type *</label>
                                <select class="form-select" id="speciesType" required>
                                    <option value="" selected disabled>Select type...</option>
                                    <option value="flora">Flora</option>
                                    <option value="fauna">Fauna</option>
                                    <option value="fungi">Fungi</option>
                                    <option value="other">Other</option>
                                </select>
                                <div class="invalid-feedback">Please select a type.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="speciesStatus" class="form-label">Status *</label>
                                <select class="form-select" id="speciesStatus" required>
                                    <option value="" selected disabled>Select status...</option>
                                    <option value="native">Native</option>
                                    <option value="introduced">Introduced</option>
                                    <option value="weed">Weed</option>
                                    <option value="pest">Pest</option>
                                    <option value="endangered">Endangered</option>
                                    <option value="vulnerable">Vulnerable</option>
                                    <option value="threatened">Threatened</option>
                                </select>
                                <div class="invalid-feedback">Please select a status.</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="speciesDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="speciesDescription" rows="3" maxlength="1000"></textarea>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="speciesHabitat" class="form-label">Habitat</label>
                                <input type="text" class="form-control" id="speciesHabitat" maxlength="200">
                            </div>
                            <div class="col-md-6">
                                <label for="speciesLastObserved" class="form-label">Last Observed</label>
                                <input type="date" class="form-control" id="speciesLastObserved">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="speciesImage" class="form-label">Image</label>
                            <input class="form-control" type="file" id="speciesImage" accept="image/*">
                            <img id="speciesImagePreview" class="species-image-preview" src="#" alt="Species image preview">
                        </div>

                        <div class="mb-3">
                            <label for="speciesNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="speciesNotes" rows="2" maxlength="500"></textarea>
                        </div>
                    </form>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2" aria-hidden="true"></i>
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="saveSpeciesBtn">
                        <i class="bi bi-check-circle me-2" aria-hidden="true"></i>
                        Save Species
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Monitoring Modal -->
    <div class="modal fade" id="modalNewMonitoring" tabindex="-1" aria-labelledby="modalNewMonitoringLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalNewMonitoringLabel">
                        <i class="bi bi-binoculars me-2" aria-hidden="true"></i>
                        New Monitoring Activity
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <form id="formNewMonitoring" novalidate>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="monitoringType" class="form-label">Monitoring Type *</label>
                                <select class="form-select" id="monitoringType" required>
                                    <option value="" selected disabled>Select type...</option>
                                    <option value="fauna-survey">Fauna Survey</option>
                                    <option value="vegetation-survey">Vegetation Survey</option>
                                    <option value="water-quality">Water Quality Testing</option>
                                    <option value="weed-mapping">Weed Mapping</option>
                                    <option value="erosion-monitoring">Erosion Monitoring</option>
                                    <option value="other">Other</option>
                                </select>
                                <div class="invalid-feedback">Please select a monitoring type.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="monitoringDate" class="form-label">Date *</label>
                                <input type="date" class="form-control" id="monitoringDate" required>
                                <div class="invalid-feedback">Please provide a date.</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="monitoringLocation" class="form-label">Location *</label>
                            <input type="text" class="form-control" id="monitoringLocation" required maxlength="200">
                            <div class="invalid-feedback">Please provide a location.</div>
                        </div>

                        <div class="mb-3">
                            <label for="monitoringObserver" class="form-label">Observer *</label>
                            <input type="text" class="form-control" id="monitoringObserver" required maxlength="100">
                            <div class="invalid-feedback">Please specify the observer.</div>
                        </div>

                        <div class="mb-3">
                            <label for="monitoringFindings" class="form-label">Findings *</label>
                            <textarea class="form-control" id="monitoringFindings" rows="3" required maxlength="2000"></textarea>
                            <div class="invalid-feedback">Please provide findings.</div>
                        </div>

                        <div class="mb-3">
                            <label for="monitoringSpecies" class="form-label">Species Observed (if applicable)</label>
                            <select class="form-select" id="monitoringSpecies" multiple size="4">
                                <!-- Species options will be loaded dynamically -->
                            </select>
                            <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                        </div>

                        <div class="mb-3">
                            <label for="monitoringPhotos" class="form-label">Upload Photos</label>
                            <input class="form-control" type="file" id="monitoringPhotos" multiple accept="image/*">
                            <div class="image-preview-container" id="monitoringPhotoPreview"></div>
                        </div>

                        <div class="mb-3">
                            <label for="monitoringNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="monitoringNotes" rows="2" maxlength="500"></textarea>
                        </div>
                    </form>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2" aria-hidden="true"></i>
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="saveMonitoringBtn">
                        <i class="bi bi-check-circle me-2" aria-hidden="true"></i>
                        Save Monitoring
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Fauna Sighting Modal -->
    <div class="modal fade" id="modalFaunaSighting" tabindex="-1" aria-labelledby="modalFaunaSightingLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalFaunaSightingLabel">
                        <i class="bi bi-paw me-2" aria-hidden="true"></i>
                        New Fauna Sighting
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <form id="formFaunaSighting" novalidate>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="faunaSpecies" class="form-label">Species *</label>
                                <select class="form-select" id="faunaSpecies" required>
                                    <option value="" selected disabled>Select species...</option>
                                    <!-- Species options will be loaded dynamically -->
                                </select>
                                <div class="invalid-feedback">Please select a species.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="faunaDate" class="form-label">Date *</label>
                                <input type="date" class="form-control" id="faunaDate" required>
                                <div class="invalid-feedback">Please provide a date.</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="faunaLocation" class="form-label">Location *</label>
                            <input type="text" class="form-control" id="faunaLocation" required maxlength="200">
                            <div class="invalid-feedback">Please provide a location.</div>
                        </div>

                        <div class="mb-3">
                            <label for="faunaObserver" class="form-label">Observer *</label>
                            <input type="text" class="form-control" id="faunaObserver" required maxlength="100">
                            <div class="invalid-feedback">Please specify the observer.</div>
                        </div>

                        <div class="mb-3">
                            <label for="faunaCount" class="form-label">Count</label>
                            <input type="number" class="form-control" id="faunaCount" min="1" value="1">
                        </div>

                        <div class="mb-3">
                            <label for="faunaBehavior" class="form-label">Behavior/Observations</label>
                            <textarea class="form-control" id="faunaBehavior" rows="3" maxlength="1000"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="faunaPhotos" class="form-label">Upload Photos</label>
                            <input class="form-control" type="file" id="faunaPhotos" multiple accept="image/*">
                            <div class="image-preview-container" id="faunaPhotoPreview"></div>
                        </div>

                        <div class="mb-3">
                            <label for="faunaNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="faunaNotes" rows="2" maxlength="500"></textarea>
                        </div>
                    </form>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2" aria-hidden="true"></i>
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="saveFaunaSightingBtn">
                        <i class="bi bi-check-circle me-2" aria-hidden="true"></i>
                        Save Sighting
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Vegetation Survey Modal -->
    <div class="modal fade" id="modalVegetationSurvey" tabindex="-1" aria-labelledby="modalVegetationSurveyLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalVegetationSurveyLabel">
                        <i class="bi bi-flower1 me-2" aria-hidden="true"></i>
                        New Vegetation Survey
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <form id="formVegetationSurvey" novalidate>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="vegetationDate" class="form-label">Date *</label>
                                <input type="date" class="form-control" id="vegetationDate" required>
                                <div class="invalid-feedback">Please provide a date.</div>
                            </div>
                            <div class="col-md-6">
                                <label for="vegetationObserver" class="form-label">Observer *</label>
                                <input type="text" class="form-control" id="vegetationObserver" required maxlength="100">
                                <div class="invalid-feedback">Please specify the observer.</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="vegetationLocation" class="form-label">Location *</label>
                            <input type="text" class="form-control" id="vegetationLocation" required maxlength="200">
                            <div class="invalid-feedback">Please provide a location.</div>
                        </div>

                        <div class="mb-3">
                            <label for="vegetationSpecies" class="form-label">Species Observed</label>
                            <select class="form-select" id="vegetationSpecies" multiple size="4">
                                <!-- Species options will be loaded dynamically -->
                            </select>
                            <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="vegetationCover" class="form-label">Native Cover (%)</label>
                                <input type="number" class="form-control" id="vegetationCover" min="0" max="100" step="1">
                            </div>
                            <div class="col-md-4">
                                <label for="vegetationWeedCover" class="form-label">Weed Cover (%)</label>
                                <input type="number" class="form-control" id="vegetationWeedCover" min="0" max="100" step="1">
                            </div>
                            <div class="col-md-4">
                                <label for="vegetationHealth" class="form-label">Health Rating</label>
                                <select class="form-select" id="vegetationHealth">
                                    <option value="" selected disabled>Select rating...</option>
                                    <option value="excellent">Excellent</option>
                                    <option value="good">Good</option>
                                    <option value="fair">Fair</option>
                                    <option value="poor">Poor</option>
                                    <option value="degraded">Degraded</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="vegetationFindings" class="form-label">Findings *</label>
                            <textarea class="form-control" id="vegetationFindings" rows="3" required maxlength="2000"></textarea>
                            <div class="invalid-feedback">Please provide findings.</div>
                        </div>

                        <div class="mb-3">
                            <label for="vegetationPhotos" class="form-label">Upload Photos</label>
                            <input class="form-control" type="file" id="vegetationPhotos" multiple accept="image/*">
                            <div class="image-preview-container" id="vegetationPhotoPreview"></div>
                        </div>

                        <div class="mb-3">
                            <label for="vegetationNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="vegetationNotes" rows="2" maxlength="500"></textarea>
                        </div>
                    </form>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2" aria-hidden="true"></i>
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="saveVegetationSurveyBtn">
                        <i class="bi bi-check-circle me-2" aria-hidden="true"></i>
                        Save Survey
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Generate Report Modal -->
    <div class="modal fade" id="modalGenerateReport" tabindex="-1" aria-labelledby="modalGenerateReportLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalGenerateReportLabel">
                        <i class="bi bi-file-earmark-pdf me-2" aria-hidden="true"></i>
                        Generate Report
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <form id="formGenerateReport" novalidate>
                        <div class="mb-3">
                            <label for="reportType" class="form-label">Report Type *</label>
                            <select class="form-select" id="reportType" required>
                                <option value="" selected disabled>Select report type...</option>
                                <option value="compliance">Compliance Report</option>
                                <option value="maintenance">Maintenance Summary</option>
                                <option value="monitoring">Monitoring Summary</option>
                                <option value="health-trend">Ecosystem Health Trend</option>
                                <option value="threat-management">Threat Management</option>
                            </select>
                            <div class="invalid-feedback">Please select a report type.</div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="reportStartDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="reportStartDate">
                            </div>
                            <div class="col-md-6">
                                <label for="reportEndDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="reportEndDate">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="reportFormat" class="form-label">Format *</label>
                            <select class="form-select" id="reportFormat" required>
                                <option value="pdf" selected>PDF Document</option>
                                <option value="excel">Excel Spreadsheet</option>
                                <option value="word">Word Document</option>
                            </select>
                        </div>
                    </form>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2" aria-hidden="true"></i>
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="generateReportBtn">
                        <i class="bi bi-file-earmark-check me-2" aria-hidden="true"></i>
                        Generate
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Assessment Modal -->
    <div class="modal fade" id="modalViewAssessment" tabindex="-1" aria-labelledby="modalViewAssessmentLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalViewAssessmentLabel">
                        <i class="bi bi-clipboard-data me-2" aria-hidden="true"></i>
                        Assessment Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="assessmentModalBody">
                    <!-- Content will be loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2" aria-hidden="true"></i>
                        Close
                    </button>
                    <button type="button" class="btn btn-primary" id="printAssessmentBtn">
                        <i class="bi bi-printer me-2" aria-hidden="true"></i>
                        Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Species Modal -->
    <div class="modal fade" id="modalViewSpecies" tabindex="-1" aria-labelledby="modalViewSpeciesLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalViewSpeciesLabel">
                        <i class="bi bi-tree me-2" aria-hidden="true"></i>
                        Species Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="speciesModalBody">
                    <!-- Content will be loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2" aria-hidden="true"></i>
                        Close
                    </button>
                    <button type="button" class="btn btn-primary" id="printSpeciesDetailsBtn">
                        <i class="bi bi-printer me-2" aria-hidden="true"></i>
                        Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Activity Modal -->
    <div class="modal fade" id="modalViewActivity" tabindex="-1" aria-labelledby="modalViewActivityLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalViewActivityLabel">
                        <i class="bi bi-calendar-check me-2" aria-hidden="true"></i>
                        Activity Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="activityModalBody">
                    <!-- Content will be loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2" aria-hidden="true"></i>
                        Close
                    </button>
                    <button type="button" class="btn btn-primary" id="printActivityBtn">
                        <i class="bi bi-printer me-2" aria-hidden="true"></i>
                        Print
                    </button>
                    <button type="button" class="btn btn-success" id="completeActivityBtn">
                        <i class="bi bi-check-circle me-2" aria-hidden="true"></i>
                        Mark Complete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Monitoring Modal -->
    <div class="modal fade" id="modalViewMonitoring" tabindex="-1" aria-labelledby="modalViewMonitoringLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalViewMonitoringLabel">
                        <i class="bi bi-binoculars me-2" aria-hidden="true"></i>
                        Monitoring Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="monitoringModalBody">
                    <!-- Content will be loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2" aria-hidden="true"></i>
                        Close
                    </button>
                    <button type="button" class="btn btn-primary" id="printMonitoringBtn">
                        <i class="bi bi-printer me-2" aria-hidden="true"></i>
                        Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Report Modal -->
    <div class="modal fade" id="modalViewReport" tabindex="-1" aria-labelledby="modalViewReportLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalViewReportLabel">
                        <i class="bi bi-file-earmark-text me-2" aria-hidden="true"></i>
                        Report Preview
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="reportModalBody">
                    <!-- Content will be loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2" aria-hidden="true"></i>
                        Close
                    </button>
                    <button type="button" class="btn btn-primary" id="downloadReportBtn">
                        <i class="bi bi-download me-2" aria-hidden="true"></i>
                        Download
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="modalConfirm" tabindex="-1" aria-labelledby="modalConfirmLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalConfirmLabel">
                        <i class="bi bi-exclamation-triangle me-2" aria-hidden="true"></i>
                        Confirm Action
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    Are you sure you want to perform this action?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2" aria-hidden="true"></i>
                        Cancel
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmActionBtn">
                        <i class="bi bi-check-circle me-2" aria-hidden="true"></i>
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    
    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
        (function() {
            'use strict';

            // ==================== CONSTANTS ====================
            const STORAGE_KEYS = {
                ASSESSMENTS: 'ecosystem_assessments',
                SPECIES: 'ecosystem_species',
                ACTIVITIES: 'ecosystem_activities',
                MONITORING: 'ecosystem_monitoring',
                REPORTS: 'ecosystem_reports',
                FAUNA_SIGHTINGS: 'ecosystem_fauna_sightings',
                VEGETATION_SURVEYS: 'ecosystem_vegetation_surveys',
                COMPLIANCE: 'ecosystem_compliance',
                SETTINGS: 'ecosystem_settings'
            };

            const HEALTH_RATINGS = ['excellent', 'good', 'fair', 'poor', 'degraded'];
            const SPECIES_STATUS = ['native', 'introduced', 'weed', 'pest', 'endangered', 'vulnerable', 'threatened'];
            const ACTIVITY_TYPES = ['weed-control', 'revegetation', 'erosion-control', 'fauna-survey', 'vegetation-survey', 'water-quality', 'other'];

            // ==================== INITIAL DATA ====================
            const db = {
                assessments: [],
                species: [],
                activities: [],
                monitoring: [],
                reports: [],
                faunaSightings: [],
                vegetationSurveys: [],
                complianceChecklist: [
                    { id: 1, requirement: "Identified all relevant legislation", compliant: "", evidence: "", notes: "" },
                    { id: 2, requirement: "Assessed impacts on protected matters", compliant: "", evidence: "", notes: "" },
                    { id: 3, requirement: "Obtained necessary permits/approvals", compliant: "", evidence: "", notes: "" },
                    { id: 4, requirement: "Implemented required protections", compliant: "", evidence: "", notes: "" },
                    { id: 5, requirement: "Maintained required records", compliant: "", evidence: "", notes: "" }
                ],
                settings: {
                    siteName: "Blue Mountains Conservation Area",
                    siteLocation: "NSW, Australia",
                    siteArea: 125,
                    siteDescription: "Mixed eucalypt forest with significant biodiversity values including several threatened species.",
                    userProfile: {
                        name: "John Doe",
                        email: "john.doe@example.com",
                        role: "ecologist"
                    }
                }
            };

            // ==================== UTILITY FUNCTIONS ====================
            const Utils = {
                // Safe JSON parsing
                parseJSON: function(key, defaultValue) {
                    try {
                        const item = localStorage.getItem(key);
                        return item ? JSON.parse(item) : defaultValue;
                    } catch (e) {
                        console.error(`Error parsing ${key}:`, e);
                        return defaultValue;
                    }
                },

                // Save data with error handling
                saveData: function() {
                    try {
                        localStorage.setItem(STORAGE_KEYS.ASSESSMENTS, JSON.stringify(db.assessments));
                        localStorage.setItem(STORAGE_KEYS.SPECIES, JSON.stringify(db.species));
                        localStorage.setItem(STORAGE_KEYS.ACTIVITIES, JSON.stringify(db.activities));
                        localStorage.setItem(STORAGE_KEYS.MONITORING, JSON.stringify(db.monitoring));
                        localStorage.setItem(STORAGE_KEYS.REPORTS, JSON.stringify(db.reports));
                        localStorage.setItem(STORAGE_KEYS.FAUNA_SIGHTINGS, JSON.stringify(db.faunaSightings));
                        localStorage.setItem(STORAGE_KEYS.VEGETATION_SURVEYS, JSON.stringify(db.vegetationSurveys));
                        localStorage.setItem(STORAGE_KEYS.COMPLIANCE, JSON.stringify(db.complianceChecklist));
                        localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(db.settings));
                        return true;
                    } catch (e) {
                        console.error('Error saving data:', e);
                        this.showToast('Error', 'Failed to save data. Storage may be full.', 'error');
                        return false;
                    }
                },

                // Load data from localStorage
                loadData: function() {
                    db.assessments = this.parseJSON(STORAGE_KEYS.ASSESSMENTS, []);
                    db.species = this.parseJSON(STORAGE_KEYS.SPECIES, []);
                    db.activities = this.parseJSON(STORAGE_KEYS.ACTIVITIES, []);
                    db.monitoring = this.parseJSON(STORAGE_KEYS.MONITORING, []);
                    db.reports = this.parseJSON(STORAGE_KEYS.REPORTS, []);
                    db.faunaSightings = this.parseJSON(STORAGE_KEYS.FAUNA_SIGHTINGS, []);
                    db.vegetationSurveys = this.parseJSON(STORAGE_KEYS.VEGETATION_SURVEYS, []);
                    db.complianceChecklist = this.parseJSON(STORAGE_KEYS.COMPLIANCE, db.complianceChecklist);
                    db.settings = this.parseJSON(STORAGE_KEYS.SETTINGS, db.settings);
                },

                // Sanitize HTML to prevent XSS
                sanitizeHTML: function(str) {
                    if (!str) return '';
                    const div = document.createElement('div');
                    div.textContent = str;
                    return div.innerHTML;
                },

                // Format date
                formatDate: function(dateString) {
                    if (!dateString) return 'Not specified';
                    try {
                        const date = new Date(dateString);
                        if (isNaN(date.getTime())) return 'Invalid date';
                        return date.toLocaleDateString('en-AU', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });
                    } catch (e) {
                        return dateString;
                    }
                },

                // Format date and time
                formatDateTime: function(dateTimeString) {
                    if (!dateTimeString) return 'Not specified';
                    try {
                        const date = new Date(dateTimeString);
                        if (isNaN(date.getTime())) return 'Invalid date';
                        return date.toLocaleDateString('en-AU', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } catch (e) {
                        return dateTimeString;
                    }
                },

                // Capitalize first letter
                capitalize: function(str) {
                    if (!str) return '';
                    return str.charAt(0).toUpperCase() + str.slice(1);
                },

                // Show toast notification
                showToast: function(title, message, type = 'success') {
                    const container = document.getElementById('toastContainer');
                    if (!container) return;

                    const toastId = 'toast-' + Date.now();
                    const bgClass = type === 'success' ? 'bg-success' :
                                   type === 'error' ? 'bg-danger' :
                                   type === 'warning' ? 'bg-warning' : 'bg-info';

                    const toastHtml = `
                        <div id="${toastId}" class="toast ${bgClass} text-white fade show" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="toast-header ${bgClass} text-white">
                                <strong class="me-auto">${Utils.sanitizeHTML(title)}</strong>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                            <div class="toast-body">
                                ${Utils.sanitizeHTML(message)}
                            </div>
                        </div>
                    `;

                    container.insertAdjacentHTML('beforeend', toastHtml);
                    const toastElement = document.getElementById(toastId);
                    const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
                    toast.show();

                    // Remove from DOM after hiding
                    toastElement.addEventListener('hidden.bs.toast', function() {
                        this.remove();
                    });
                },

                // Show confirmation dialog
                showConfirmation: function(title, message, onConfirm) {
                    const modal = new bootstrap.Modal(document.getElementById('modalConfirm'));
                    document.getElementById('confirmModalBody').innerHTML = this.sanitizeHTML(message);
                    document.getElementById('modalConfirmLabel').innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${this.sanitizeHTML(title)}`;
                    
                    const confirmBtn = document.getElementById('confirmActionBtn');
                    const newBtn = confirmBtn.cloneNode(true);
                    confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
                    newBtn.id = 'confirmActionBtn';
                    
                    newBtn.addEventListener('click', function() {
                        onConfirm();
                        modal.hide();
                    });
                    
                    modal.show();
                },

                // Validate email
                isValidEmail: function(email) {
                    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    return re.test(email);
                },

                // Generate unique ID
                generateId: function() {
                    return Date.now() + Math.floor(Math.random() * 1000);
                },

                // Revoke object URLs to prevent memory leaks
                revokeObjectURLs: function(urls) {
                    if (Array.isArray(urls)) {
                        urls.forEach(url => {
                            if (url && url.startsWith('blob:')) {
                                URL.revokeObjectURL(url);
                            }
                        });
                    }
                }
            };

            // ==================== CORE FUNCTIONS ====================
            const App = {
                // Initialize the application
                init: function() {
                    Utils.loadData();
                    this.loadInitialData();
                    
                    // Wait for DOM and libraries to load
                    setTimeout(() => {
                        this.initCharts();
                        this.initMap();
                        this.initCalendar();
                        this.loadDashboard();
                        this.loadAssessments();
                        this.loadSpecies();
                        this.loadActivities();
                        this.loadMonitoring();
                        this.loadReports();
                        this.loadComplianceChecklist();
                        this.loadSettings();
                        this.setupEventListeners();
                        this.updateStorageInfo();
                    }, 500);
                },

                // Load initial test data if empty
                loadInitialData: function() {
                    if (db.assessments.length === 0) {
                        db.assessments = [
                            {
                                id: 1,
                                date: '2023-06-15',
                                assessor: 'Jane Doe',
                                description: 'Initial assessment of the northern section of the conservation area. Found healthy native vegetation but some weed infestations.',
                                components: ['flora', 'fauna', 'soil'],
                                health: 'good',
                                threats: ['weeds', 'erosion'],
                                photos: [],
                                createdAt: '2023-06-15T10:30:00Z'
                            },
                            {
                                id: 2,
                                date: '2023-03-02',
                                assessor: 'John Smith',
                                description: 'Quarterly assessment of the entire site. Noted increased weed coverage in Zone 3.',
                                components: ['flora', 'fauna', 'water'],
                                health: 'fair',
                                threats: ['weeds', 'pests'],
                                photos: [],
                                createdAt: '2023-03-02T14:15:00Z'
                            }
                        ];
                    }

                    if (db.species.length === 0) {
                        db.species = [
                            {
                                id: 1,
                                scientificName: 'Eucalyptus pauciflora',
                                commonName: 'Snow Gum',
                                type: 'flora',
                                status: 'native',
                                description: 'A small to medium-sized tree with smooth bark, native to southeastern Australia.',
                                habitat: 'Alpine and subalpine areas',
                                lastObserved: '2023-06-15',
                                image: '',
                                notes: 'Dominant species in Zone 1',
                                createdAt: '2023-01-10T09:20:00Z'
                            },
                            {
                                id: 2,
                                scientificName: 'Rubus fruticosus',
                                commonName: 'Blackberry',
                                type: 'flora',
                                status: 'weed',
                                description: 'Invasive shrub with thorny stems and edible black berries.',
                                habitat: 'Disturbed areas, forest edges',
                                lastObserved: '2023-06-10',
                                image: '',
                                notes: 'Expanding in Zone 3, requires control',
                                createdAt: '2023-02-15T11:45:00Z'
                            },
                            {
                                id: 3,
                                scientificName: 'Phascolarctos cinereus',
                                commonName: 'Koala',
                                type: 'fauna',
                                status: 'endangered',
                                description: 'Arboreal herbivorous marsupial native to Australia.',
                                habitat: 'Eucalyptus forests',
                                lastObserved: '2023-06-05',
                                image: '',
                                notes: 'Single individual observed in Zone 1',
                                createdAt: '2023-03-20T08:30:00Z'
                            }
                        ];
                    }

                    if (db.activities.length === 0) {
                        db.activities = [
                            {
                                id: 1,
                                type: 'weed-control',
                                title: 'Weed Control - Blackberry',
                                startDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 7 days from now
                                endDate: null,
                                location: 'Zone 3',
                                description: 'Target species: Blackberry. Manual removal and herbicide application.',
                                assignedTo: 'John Smith',
                                priority: 'high',
                                status: 'planned',
                                notes: 'Wear protective clothing due to thorns',
                                createdAt: new Date().toISOString()
                            },
                            {
                                id: 2,
                                type: 'fauna-survey',
                                title: 'Fauna Survey - Eastern Zone',
                                startDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString(),
                                endDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000 + 8 * 60 * 60 * 1000).toISOString(),
                                location: 'Eastern Zone',
                                description: 'Standardized survey of fauna species in the eastern section.',
                                assignedTo: 'Survey Team',
                                priority: 'medium',
                                status: 'planned',
                                notes: 'Focus on threatened species',
                                createdAt: new Date().toISOString()
                            },
                            {
                                id: 3,
                                type: 'revegetation',
                                title: 'Revegetation Planting',
                                startDate: new Date(Date.now() + 21 * 24 * 60 * 60 * 1000).toISOString(),
                                endDate: new Date(Date.now() + 21 * 24 * 60 * 60 * 1000 + 6 * 60 * 60 * 1000).toISOString(),
                                location: 'Zone 1',
                                description: 'Planting 200 native shrubs in previously cleared area.',
                                assignedTo: 'Volunteer Group',
                                priority: 'medium',
                                status: 'planned',
                                notes: 'Species: Acacia and Banksia',
                                createdAt: new Date().toISOString()
                            },
                            {
                                id: 4,
                                type: 'erosion-control',
                                title: 'Erosion Control - North Bank',
                                startDate: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                                endDate: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000 + 8 * 60 * 60 * 1000).toISOString(),
                                location: 'Northern Boundary',
                                description: 'Install erosion control matting and plant stabilizing vegetation.',
                                assignedTo: 'Grounds Team',
                                priority: 'high',
                                status: 'completed',
                                notes: 'Completed on schedule',
                                createdAt: new Date().toISOString()
                            }
                        ];
                    }

                    if (db.monitoring.length === 0) {
                        db.monitoring = [
                            {
                                id: 1,
                                type: 'vegetation-survey',
                                date: '2023-06-15',
                                location: 'Zone 1',
                                observer: 'Jane Doe',
                                findings: 'Increased native cover compared to last survey. Weed cover reduced by 15%.',
                                species: [1],
                                photos: [],
                                notes: 'Positive trend in vegetation recovery',
                                createdAt: '2023-06-15T16:45:00Z'
                            },
                            {
                                id: 2,
                                type: 'fauna-survey',
                                date: '2023-06-12',
                                location: 'Eastern Zone',
                                observer: 'Survey Team',
                                findings: 'Koala sighting confirmed. Also observed several bird species including bush stone-curlew.',
                                species: [3],
                                photos: [],
                                notes: 'First confirmed koala sighting in 2 years',
                                createdAt: '2023-06-12T17:30:00Z'
                            }
                        ];
                    }

                    if (db.reports.length === 0) {
                        db.reports = [
                            {
                                id: 1,
                                type: 'compliance',
                                date: new Date().toISOString(),
                                generatedBy: 'Jane Doe',
                                period: 'All time',
                                content: {
                                    title: 'Compliance Report',
                                    body: 'Report generated for Blue Mountains Conservation Area',
                                    progress: 60,
                                    checklist: db.complianceChecklist
                                },
                                format: 'pdf',
                                createdAt: new Date().toISOString()
                            }
                        ];
                    }

                    Utils.saveData();
                },

                // Update storage information
                updateStorageInfo: function() {
                    try {
                        let totalSize = 0;
                        Object.keys(STORAGE_KEYS).forEach(key => {
                            const item = localStorage.getItem(STORAGE_KEYS[key]);
                            if (item) totalSize += item.length * 2; // Approximate size in bytes
                        });

                        const recordsCount = db.assessments.length + db.species.length + db.activities.length + 
                                            db.monitoring.length + db.reports.length;

                        document.getElementById('storageUsed').textContent = 
                            totalSize > 1024 * 1024 ? `${(totalSize / (1024 * 1024)).toFixed(2)} MB` :
                            totalSize > 1024 ? `${(totalSize / 1024).toFixed(2)} KB` : `${totalSize} bytes`;
                        
                        document.getElementById('recordsCount').textContent = recordsCount;
                        document.getElementById('lastBackupInfo').textContent = 
                            localStorage.getItem('lastBackup') || 'Never';
                    } catch (e) {
                        console.error('Error calculating storage:', e);
                    }
                },

                // ==================== CHART FUNCTIONS ====================
                initCharts: function() {
                    // Health Chart
                    const healthCtx = document.getElementById('healthChart');
                    if (healthCtx) {
                        try {
                            window.healthChart = new Chart(healthCtx, {
                                type: 'radar',
                                data: {
                                    labels: ['Biodiversity', 'Native Cover', 'Weed Pressure', 'Erosion', 'Fauna Activity', 'Water Quality'],
                                    datasets: [{
                                        label: 'Current',
                                        data: [78, 65, 22, 15, 70, 85],
                                        backgroundColor: 'rgba(40, 167, 69, 0.2)',
                                        borderColor: 'rgba(40, 167, 69, 1)',
                                        borderWidth: 1,
                                        pointBackgroundColor: 'rgba(40, 167, 69, 1)'
                                    }, {
                                        label: 'Previous',
                                        data: [72, 60, 28, 18, 65, 80],
                                        backgroundColor: 'rgba(108, 117, 125, 0.2)',
                                        borderColor: 'rgba(108, 117, 125, 1)',
                                        borderWidth: 1,
                                        pointBackgroundColor: 'rgba(108, 117, 125, 1)'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: true,
                                    scales: {
                                        r: {
                                            beginAtZero: true,
                                            max: 100,
                                            ticks: {
                                                stepSize: 20
                                            }
                                        }
                                    },
                                    plugins: {
                                        legend: {
                                            position: 'bottom'
                                        }
                                    }
                                }
                            });
                        } catch (e) {
                            console.error('Error creating health chart:', e);
                        }
                    }

                    // Fauna Chart
                    const faunaCtx = document.getElementById('faunaChart');
                    if (faunaCtx) {
                        try {
                            window.faunaChart = new Chart(faunaCtx, {
                                type: 'line',
                                data: {
                                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                                    datasets: [{
                                        label: 'Koala',
                                        data: [2, 3, 1, 4, 3, 2],
                                        borderColor: 'rgba(220, 53, 69, 1)',
                                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                        tension: 0.1,
                                        fill: true
                                    }, {
                                        label: 'Bush Stone-curlew',
                                        data: [5, 4, 6, 3, 5, 7],
                                        borderColor: 'rgba(255, 193, 7, 1)',
                                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                                        tension: 0.1,
                                        fill: true
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    plugins: {
                                        legend: {
                                            position: 'top',
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            ticks: {
                                                stepSize: 1
                                            }
                                        }
                                    }
                                }
                            });
                        } catch (e) {
                            console.error('Error creating fauna chart:', e);
                        }
                    }

                    // Vegetation Chart
                    const vegetationCtx = document.getElementById('vegetationChart');
                    if (vegetationCtx) {
                        try {
                            window.vegetationChart = new Chart(vegetationCtx, {
                                type: 'bar',
                                data: {
                                    labels: ['Zone 1', 'Zone 2', 'Zone 3', 'Zone 4'],
                                    datasets: [{
                                        label: 'Native Cover (%)',
                                        data: [75, 60, 45, 80],
                                        backgroundColor: 'rgba(40, 167, 69, 0.7)',
                                    }, {
                                        label: 'Weed Cover (%)',
                                        data: [15, 25, 40, 10],
                                        backgroundColor: 'rgba(220, 53, 69, 0.7)',
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    plugins: {
                                        legend: {
                                            position: 'top',
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            max: 100
                                        }
                                    }
                                }
                            });
                        } catch (e) {
                            console.error('Error creating vegetation chart:', e);
                        }
                    }
                },

                // ==================== MAP FUNCTIONS ====================
                initMap: function() {
                    const mapElement = document.getElementById('map');
                    if (!mapElement) return;

                    try {
                        if (typeof L === 'undefined') {
                            mapElement.innerHTML = '<div class="alert alert-warning">Map library could not be loaded. Please check your internet connection.</div>';
                            return;
                        }

                        // Initialize map
                        window.map = L.map('map').setView([-33.4000, 150.3000], 13);

                        // Add tile layer
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                            maxZoom: 19
                        }).addTo(window.map);

                        // Add marker
                        const marker = L.marker([-33.4000, 150.3000]).addTo(window.map)
                            .bindPopup('Blue Mountains Conservation Area')
                            .openPopup();

                        // Create zone polygons
                        const zone1 = L.polygon([
                            [-33.41, 150.29],
                            [-33.41, 150.31],
                            [-33.39, 150.31],
                            [-33.39, 150.29]
                        ], {
                            color: '#3498db',
                            weight: 2,
                            opacity: 0.8,
                            fillOpacity: 0.2
                        }).bindPopup('Zone 1 - Native Forest');

                        const zone2 = L.polygon([
                            [-33.42, 150.305],
                            [-33.42, 150.315],
                            [-33.40, 150.315],
                            [-33.40, 150.305]
                        ], {
                            color: '#27ae60',
                            weight: 2,
                            opacity: 0.8,
                            fillOpacity: 0.2
                        }).bindPopup('Zone 2 - Wetland Area');

                        const zone3 = L.polygon([
                            [-33.38, 150.295],
                            [-33.38, 150.305],
                            [-33.36, 150.305],
                            [-33.36, 150.295]
                        ], {
                            color: '#e74c3c',
                            weight: 2,
                            opacity: 0.8,
                            fillOpacity: 0.2
                        }).bindPopup('Zone 3 - Weed Control Area');

                        // Create layer groups
                        window.zonesLayer = L.layerGroup([zone1, zone2, zone3]);
                        window.vegetationLayer = L.layerGroup();
                        window.weedsLayer = L.layerGroup();

                        // Add vegetation markers
                        L.marker([-33.405, 150.302]).addTo(window.vegetationLayer)
                            .bindPopup('Eucalyptus pauciflora (Snow Gum)');
                        L.marker([-33.404, 150.304]).addTo(window.vegetationLayer)
                            .bindPopup('Acacia melanoxylon (Blackwood)');
                        L.marker([-33.406, 150.301]).addTo(window.vegetationLayer)
                            .bindPopup('Banksia marginata (Silver Banksia)');

                        // Add weed markers
                        L.marker([-33.365, 150.301]).addTo(window.weedsLayer)
                            .bindPopup('Rubus fruticosus (Blackberry)');
                        L.marker([-33.364, 150.303]).addTo(window.weedsLayer)
                            .bindPopup('Lantana camara (Lantana)');
                        L.marker([-33.366, 150.302]).addTo(window.weedsLayer)
                            .bindPopup('Ulex europaeus (Gorse)');

                        // Default to showing zones
                        window.zonesLayer.addTo(window.map);

                    } catch (error) {
                        console.error('Error initializing map:', error);
                        mapElement.innerHTML = '<div class="alert alert-warning">Map could not be loaded. Please refresh the page.</div>';
                    }
                },

                // ==================== CALENDAR FUNCTIONS ====================
                initCalendar: function() {
                    const calendarEl = document.getElementById('calendar');
                    if (!calendarEl) return;

                    try {
                        if (typeof FullCalendar === 'undefined') {
                            calendarEl.innerHTML = '<div class="alert alert-warning">Calendar could not be loaded.</div>';
                            return;
                        }

                        const events = db.activities.map(activity => ({
                            id: activity.id.toString(),
                            title: activity.title,
                            start: activity.startDate,
                            end: activity.endDate || activity.startDate,
                            extendedProps: {
                                type: activity.type,
                                location: activity.location,
                                assignedTo: activity.assignedTo,
                                status: activity.status
                            },
                            backgroundColor: this.getActivityColor(activity.type),
                            borderColor: this.getActivityColor(activity.type),
                            textColor: '#fff'
                        }));

                        window.calendar = new FullCalendar.Calendar(calendarEl, {
                            initialView: 'dayGridMonth',
                            headerToolbar: {
                                left: 'prev,next today',
                                center: 'title',
                                right: 'dayGridMonth,timeGridWeek,timeGridDay'
                            },
                            events: events,
                            eventClick: function(info) {
                                const activity = db.activities.find(a => a.id.toString() === info.event.id);
                                if (activity) {
                                    App.showActivityDetails(activity);
                                }
                            },
                            eventDidMount: function(info) {
                                // Add tooltip
                                info.el.setAttribute('title', 
                                    `${info.event.title}\nType: ${info.event.extendedProps.type}\nLocation: ${info.event.extendedProps.location}`
                                );
                            },
                            height: 600,
                            stickyHeaderDates: true
                        });

                        window.calendar.render();
                    } catch (error) {
                        console.error('Error initializing calendar:', error);
                        calendarEl.innerHTML = '<div class="alert alert-warning">Calendar could not be loaded.</div>';
                    }
                },

                getActivityColor: function(type) {
                    const colors = {
                        'weed-control': '#dc3545',
                        'revegetation': '#28a745',
                        'erosion-control': '#fd7e14',
                        'fauna-survey': '#17a2b8',
                        'vegetation-survey': '#20c997',
                        'water-quality': '#007bff'
                    };
                    return colors[type] || '#6c757d';
                },

                // ==================== DASHBOARD FUNCTIONS ====================
                loadDashboard: function() {
                    // Update stats
                    const upcomingTasks = db.activities.filter(a => a.status !== 'completed' && a.status !== 'cancelled');
                    document.getElementById('totalTasks').textContent = upcomingTasks.length;
                    document.getElementById('totalAssessments').textContent = db.assessments.length;
                    document.getElementById('totalSpecies').textContent = db.species.length;

                    const completedItems = db.complianceChecklist.filter(item => item.compliant === 'Yes').length;
                    const totalItems = db.complianceChecklist.length;
                    const progress = totalItems ? Math.round((completedItems / totalItems) * 100) : 0;
                    document.getElementById('compliancePercent').textContent = `${progress}%`;

                    // Upcoming tasks list
                    const tasksList = document.getElementById('upcomingTasksList');
                    if (tasksList) {
                        tasksList.innerHTML = '';

                        if (upcomingTasks.length === 0) {
                            tasksList.innerHTML = `
                                <div class="empty-state">
                                    <i class="bi bi-check-circle"></i>
                                    <p>No upcoming tasks</p>
                                </div>
                            `;
                        } else {
                            upcomingTasks
                                .sort((a, b) => new Date(a.startDate) - new Date(b.startDate))
                                .slice(0, 5)
                                .forEach(task => {
                                    const item = document.createElement('a');
                                    item.href = '#';
                                    item.className = 'list-group-item list-group-item-action';
                                    item.setAttribute('role', 'listitem');
                                    item.innerHTML = `
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">${Utils.sanitizeHTML(task.title)}</h6>
                                            <small class="text-muted">${Utils.formatDate(task.startDate)}</small>
                                        </div>
                                        <p class="mb-1">${Utils.sanitizeHTML(task.description.substring(0, 50))}${task.description.length > 50 ? '...' : ''}</p>
                                        <small class="text-muted">Assigned to: ${Utils.sanitizeHTML(task.assignedTo)}</small>
                                    `;
                                    item.addEventListener('click', (e) => {
                                        e.preventDefault();
                                        this.showActivityDetails(task);
                                    });
                                    tasksList.appendChild(item);
                                });
                        }
                    }

                    // Recent observations
                    const observationsList = document.getElementById('recentObservationsList');
                    if (observationsList) {
                        observationsList.innerHTML = '';

                        const recent = db.monitoring
                            .sort((a, b) => new Date(b.date) - new Date(a.date))
                            .slice(0, 4);

                        if (recent.length === 0) {
                            observationsList.innerHTML = `
                                <li class="list-group-item empty-state">
                                    <i class="bi bi-binoculars"></i>
                                    <p>No recent observations</p>
                                </li>
                            `;
                        } else {
                            recent.forEach(obs => {
                                const item = document.createElement('li');
                                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                                item.setAttribute('role', 'listitem');
                                item.innerHTML = `
                                    ${obs.type === 'fauna-survey' ? 'Fauna sighting' : 'Vegetation survey'}
                                    <span class="badge ${obs.type === 'fauna-survey' ? 'bg-info' : 'bg-success'} rounded-pill">
                                        ${Utils.formatDate(obs.date)}
                                    </span>
                                `;
                                item.addEventListener('click', () => this.showMonitoringDetails(obs));
                                observationsList.appendChild(item);
                            });
                        }
                    }

                    // Compliance checklist
                    const checklistDiv = document.getElementById('dashboardComplianceChecklist');
                    if (checklistDiv) {
                        checklistDiv.innerHTML = '';

                        const progressBar = document.getElementById('complianceProgress');
                        if (progressBar) {
                            progressBar.style.width = `${progress}%`;
                            progressBar.textContent = `${progress}% Complete`;
                            progressBar.setAttribute('aria-valuenow', progress);
                        }

                        db.complianceChecklist.forEach(item => {
                            const checkDiv = document.createElement('div');
                            checkDiv.className = 'form-check mb-2';
                            checkDiv.innerHTML = `
                                <input class="form-check-input" type="checkbox" 
                                       id="dashCheck${item.id}" ${item.compliant === 'Yes' ? 'checked' : ''} disabled>
                                <label class="form-check-label" for="dashCheck${item.id}">
                                    ${Utils.sanitizeHTML(item.requirement)}
                                </label>
                            `;
                            checklistDiv.appendChild(checkDiv);
                        });
                    }
                },

                // ==================== ASSESSMENT FUNCTIONS ====================
                loadAssessments: function() {
                    const table = document.getElementById('assessmentsTable');
                    if (!table) return;

                    const tbody = table.querySelector('tbody');
                    tbody.innerHTML = '';

                    if (db.assessments.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center">
                                    <div class="empty-state">
                                        <i class="bi bi-clipboard-data"></i>
                                        <p>No assessments recorded yet</p>
                                        <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#modalNewAssessment">
                                            Create First Assessment
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        db.assessments.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(assessment => {
                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td data-label="Date">${Utils.formatDate(assessment.date)}</td>
                                <td data-label="Assessor">${Utils.sanitizeHTML(assessment.assessor)}</td>
                                <td data-label="Health Rating">
                                    <span class="badge ${this.getHealthBadgeClass(assessment.health)}">
                                        ${Utils.capitalize(assessment.health)}
                                    </span>
                                </td>
                                <td data-label="Main Threats">${assessment.threats.map(t => Utils.capitalize(t)).join(', ') || 'None'}</td>
                                <td data-label="Actions">
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-outline-primary view-assessment" data-id="${assessment.id}">
                                            <i class="bi bi-eye"></i> View
                                        </button>
                                    </div>
                                </td>
                            `;
                        });
                    }

                    // Add event listeners
                    document.querySelectorAll('.view-assessment').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const id = parseInt(btn.dataset.id);
                            const assessment = db.assessments.find(a => a.id === id);
                            if (assessment) this.showAssessmentDetails(assessment);
                        });
                    });
                },

                saveAssessment: function() {
                    const form = document.getElementById('formNewAssessment');
                    if (!form.checkValidity()) {
                        form.classList.add('was-validated');
                        
                        // Check components
                        const components = document.querySelectorAll('#formNewAssessment input[name="components"]:checked');
                        if (components.length === 0) {
                            document.getElementById('componentsFeedback').style.display = 'block';
                        }
                        return;
                    }

                    const components = Array.from(document.querySelectorAll('#formNewAssessment input[name="components"]:checked'))
                        .map(cb => cb.value);
                    
                    if (components.length === 0) {
                        document.getElementById('componentsFeedback').style.display = 'block';
                        return;
                    }

                    const threats = Array.from(document.getElementById('modalThreats').selectedOptions)
                        .map(opt => opt.value);

                    const newAssessment = {
                        id: Utils.generateId(),
                        date: document.getElementById('modalAssessmentDate').value,
                        assessor: document.getElementById('modalAssessorName').value,
                        description: document.getElementById('modalSiteDescription').value,
                        components: components,
                        health: document.getElementById('modalEcosystemHealth').value,
                        threats: threats,
                        photos: [], // Would handle file uploads in production
                        createdAt: new Date().toISOString()
                    };

                    db.assessments.push(newAssessment);
                    
                    if (Utils.saveData()) {
                        form.reset();
                        form.classList.remove('was-validated');
                        document.getElementById('componentsFeedback').style.display = 'none';
                        document.getElementById('assessmentPhotoPreview').innerHTML = '';
                        
                        bootstrap.Modal.getInstance(document.getElementById('modalNewAssessment')).hide();
                        Utils.showToast('Success', 'Assessment saved successfully!');
                        
                        this.loadAssessments();
                        this.loadDashboard();
                    }
                },

                showAssessmentDetails: function(assessment) {
                    const modalBody = document.getElementById('assessmentModalBody');
                    if (!modalBody) return;

                    modalBody.innerHTML = `
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Assessment Date</h6>
                                <p>${Utils.formatDate(assessment.date)}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Assessor</h6>
                                <p>${Utils.sanitizeHTML(assessment.assessor)}</p>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Site Description</h6>
                            <p>${Utils.sanitizeHTML(assessment.description)}</p>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Ecosystem Components</h6>
                                <ul class="list-unstyled">
                                    ${assessment.components.map(c => `<li><i class="bi bi-check-circle-fill text-success me-2"></i>${Utils.capitalize(c)}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Health Assessment</h6>
                                <span class="badge ${this.getHealthBadgeClass(assessment.health)}">${Utils.capitalize(assessment.health)}</span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Identified Threats</h6>
                            <p>${assessment.threats.length > 0 ? assessment.threats.map(t => Utils.capitalize(t)).join(', ') : 'None identified'}</p>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Record Created</h6>
                            <p>${Utils.formatDateTime(assessment.createdAt)}</p>
                        </div>
                    `;

                    new bootstrap.Modal(document.getElementById('modalViewAssessment')).show();
                },

                getHealthBadgeClass: function(health) {
                    const classes = {
                        'excellent': 'bg-success',
                        'good': 'bg-success',
                        'fair': 'bg-warning',
                        'poor': 'bg-danger',
                        'degraded': 'bg-danger'
                    };
                    return classes[health] || 'bg-secondary';
                },

                // ==================== SPECIES FUNCTIONS ====================
                loadSpecies: function() {
                    // Load species cards
                    const cardsContainer = document.getElementById('speciesCardsContainer');
                    if (cardsContainer) {
                        cardsContainer.innerHTML = '';

                        const recentSpecies = db.species
                            .sort((a, b) => new Date(b.lastObserved || 0) - new Date(a.lastObserved || 0))
                            .slice(0, 3);

                        if (recentSpecies.length === 0) {
                            cardsContainer.innerHTML = `
                                <div class="col-12">
                                    <div class="empty-state">
                                        <i class="bi bi-tree"></i>
                                        <p>No species recorded yet</p>
                                        <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#modalNewSpecies">
                                            Add First Species
                                        </button>
                                    </div>
                                </div>
                            `;
                        } else {
                            recentSpecies.forEach(species => {
                                const col = document.createElement('div');
                                col.className = 'col-md-4 mb-4';
                                col.innerHTML = `
                                    <div class="card h-100 species-card">
                                        <img src="${species.image || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'300\' height=\'200\' viewBox=\'0 0 300 200\'%3E%3Crect width=\'300\' height=\'200\' fill=\'%23e9ecef\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' dominant-baseline=\'middle\' text-anchor=\'middle\' font-family=\'system-ui\' font-size=\'16\' fill=\'%236c757d\'%3ENo Image%3C/text%3E%3C/svg%3E'}" 
                                             class="card-img-top" alt="${Utils.sanitizeHTML(species.scientificName)}">
                                        <div class="card-body">
                                            <h5 class="card-title">${Utils.sanitizeHTML(species.scientificName)}</h5>
                                            <h6 class="card-subtitle mb-2 text-muted">${Utils.sanitizeHTML(species.commonName) || 'No common name'}</h6>
                                            <p class="card-text">
                                                <span class="badge ${this.getSpeciesStatusBadgeClass(species.status)} me-1">${Utils.capitalize(species.status)}</span>
                                                ${species.status === 'weed' || species.status === 'pest' ? '<span class="badge bg-warning">High priority</span>' : ''}
                                            </p>
                                            <p class="card-text"><small>Last observed: ${species.lastObserved ? Utils.formatDate(species.lastObserved) : 'Not recorded'}</small></p>
                                            <button class="btn btn-sm btn-outline-primary view-species-card" data-id="${species.id}">
                                                View Details
                                            </button>
                                        </div>
                                    </div>
                                `;
                                cardsContainer.appendChild(col);
                            });
                        }
                    }

                    // Load species table
                    const table = document.getElementById('speciesTable');
                    if (!table) return;

                    const tbody = table.querySelector('tbody');
                    tbody.innerHTML = '';

                    // Update dropdowns
                    this.updateSpeciesDropdowns();

                    if (db.species.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="empty-state">
                                        <i class="bi bi-tree"></i>
                                        <p>No species recorded yet</p>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        db.species.forEach(species => {
                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td data-label="Scientific Name">${Utils.sanitizeHTML(species.scientificName)}</td>
                                <td data-label="Common Name">${Utils.sanitizeHTML(species.commonName) || '-'}</td>
                                <td data-label="Type">${Utils.capitalize(species.type)}</td>
                                <td data-label="Status">
                                    <span class="badge ${this.getSpeciesStatusBadgeClass(species.status)}">${Utils.capitalize(species.status)}</span>
                                </td>
                                <td data-label="Last Observed">${species.lastObserved ? Utils.formatDate(species.lastObserved) : 'Not recorded'}</td>
                                <td data-label="Actions">
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-outline-primary view-species" data-id="${species.id}">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                </td>
                            `;
                        });
                    }

                    // Add event listeners
                    document.querySelectorAll('.view-species, .view-species-card').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const id = parseInt(btn.dataset.id);
                            const species = db.species.find(s => s.id === id);
                            if (species) this.showSpeciesDetails(species);
                        });
                    });
                },

                updateSpeciesDropdowns: function() {
                    // Monitoring species dropdown
                    const monitoringSelect = document.getElementById('monitoringSpecies');
                    if (monitoringSelect) {
                        monitoringSelect.innerHTML = '';
                        db.species.forEach(species => {
                            const option = document.createElement('option');
                            option.value = species.id;
                            option.textContent = `${species.scientificName}${species.commonName ? ` (${species.commonName})` : ''}`;
                            monitoringSelect.appendChild(option);
                        });
                    }

                    // Fauna species dropdown
                    const faunaSelect = document.getElementById('faunaSpecies');
                    if (faunaSelect) {
                        faunaSelect.innerHTML = '<option value="" selected disabled>Select species...</option>';
                        db.species.filter(s => s.type === 'fauna').forEach(species => {
                            const option = document.createElement('option');
                            option.value = species.id;
                            option.textContent = `${species.scientificName}${species.commonName ? ` (${species.commonName})` : ''}`;
                            faunaSelect.appendChild(option);
                        });
                    }

                    // Vegetation species dropdown
                    const vegSelect = document.getElementById('vegetationSpecies');
                    if (vegSelect) {
                        vegSelect.innerHTML = '';
                        db.species.filter(s => s.type === 'flora').forEach(species => {
                            const option = document.createElement('option');
                            option.value = species.id;
                            option.textContent = `${species.scientificName}${species.commonName ? ` (${species.commonName})` : ''}`;
                            vegSelect.appendChild(option);
                        });
                    }
                },

                saveSpecies: function() {
                    const form = document.getElementById('formNewSpecies');
                    if (!form.checkValidity()) {
                        form.classList.add('was-validated');
                        return;
                    }

                    // Handle image (simplified)
                    let image = '';
                    const fileInput = document.getElementById('speciesImage');
                    if (fileInput.files.length > 0) {
                        image = URL.createObjectURL(fileInput.files[0]);
                    }

                    const newSpecies = {
                        id: Utils.generateId(),
                        scientificName: document.getElementById('speciesScientificName').value,
                        commonName: document.getElementById('speciesCommonName').value || null,
                        type: document.getElementById('speciesType').value,
                        status: document.getElementById('speciesStatus').value,
                        description: document.getElementById('speciesDescription').value,
                        habitat: document.getElementById('speciesHabitat').value || null,
                        lastObserved: document.getElementById('speciesLastObserved').value || null,
                        image: image,
                        notes: document.getElementById('speciesNotes').value,
                        createdAt: new Date().toISOString()
                    };

                    db.species.push(newSpecies);
                    
                    if (Utils.saveData()) {
                        form.reset();
                        form.classList.remove('was-validated');
                        document.getElementById('speciesImagePreview').style.display = 'none';
                        
                        bootstrap.Modal.getInstance(document.getElementById('modalNewSpecies')).hide();
                        Utils.showToast('Success', 'Species record saved successfully!');
                        
                        this.loadSpecies();
                        this.loadDashboard();
                    }
                },

                showSpeciesDetails: function(species) {
                    const modalBody = document.getElementById('speciesModalBody');
                    if (!modalBody) return;

                    modalBody.innerHTML = `
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Scientific Name</h6>
                                <p>${Utils.sanitizeHTML(species.scientificName)}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Common Name</h6>
                                <p>${Utils.sanitizeHTML(species.commonName) || 'Not specified'}</p>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Type</h6>
                                <p>${Utils.capitalize(species.type)}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Status</h6>
                                <span class="badge ${this.getSpeciesStatusBadgeClass(species.status)}">${Utils.capitalize(species.status)}</span>
                            </div>
                        </div>
                        
                        ${species.description ? `
                        <div class="mb-3">
                            <h6>Description</h6>
                            <p>${Utils.sanitizeHTML(species.description)}</p>
                        </div>
                        ` : ''}
                        
                        ${species.habitat ? `
                        <div class="mb-3">
                            <h6>Habitat</h6>
                            <p>${Utils.sanitizeHTML(species.habitat)}</p>
                        </div>
                        ` : ''}
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Last Observed</h6>
                                <p>${species.lastObserved ? Utils.formatDate(species.lastObserved) : 'Not recorded'}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Record Created</h6>
                                <p>${Utils.formatDateTime(species.createdAt)}</p>
                            </div>
                        </div>
                        
                        ${species.image ? `
                        <div class="mb-3">
                            <h6>Image</h6>
                            <img src="${species.image}" alt="${Utils.sanitizeHTML(species.scientificName)}" class="img-fluid rounded">
                        </div>
                        ` : ''}
                        
                        ${species.notes ? `
                        <div class="mb-3">
                            <h6>Notes</h6>
                            <p>${Utils.sanitizeHTML(species.notes)}</p>
                        </div>
                        ` : ''}
                    `;

                    new bootstrap.Modal(document.getElementById('modalViewSpecies')).show();
                },

                getSpeciesStatusBadgeClass: function(status) {
                    const classes = {
                        'native': 'bg-success',
                        'introduced': 'bg-secondary',
                        'weed': 'bg-danger',
                        'pest': 'bg-danger',
                        'endangered': 'bg-danger',
                        'vulnerable': 'bg-warning',
                        'threatened': 'bg-warning'
                    };
                    return classes[status] || 'bg-secondary';
                },

                // ==================== ACTIVITY FUNCTIONS ====================
                loadActivities: function() {
                    this.loadUpcomingActivities();
                    this.loadCompletedActivities();
                    this.loadOverdueActivities();
                },

                loadUpcomingActivities: function() {
                    const table = document.getElementById('upcomingActivitiesTable');
                    if (!table) return;

                    const tbody = table.querySelector('tbody');
                    tbody.innerHTML = '';

                    const upcoming = db.activities
                        .filter(a => a.status === 'planned' || a.status === 'in-progress')
                        .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

                    if (upcoming.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="empty-state">
                                        <i class="bi bi-calendar-check"></i>
                                        <p>No upcoming activities</p>
                                        <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#modalNewActivity">
                                            Schedule First Activity
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        upcoming.forEach(activity => {
                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td data-label="Activity">${Utils.sanitizeHTML(activity.title)}</td>
                                <td data-label="Type">${this.formatActivityType(activity.type)}</td>
                                <td data-label="Scheduled">${Utils.formatDateTime(activity.startDate)}</td>
                                <td data-label="Location">${Utils.sanitizeHTML(activity.location)}</td>
                                <td data-label="Assigned To">${Utils.sanitizeHTML(activity.assignedTo)}</td>
                                <td data-label="Status">
                                    <span class="badge ${this.getStatusBadgeClass(activity.status)}">${Utils.capitalize(activity.status)}</span>
                                </td>
                                <td data-label="Actions">
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-outline-primary view-activity" data-id="${activity.id}">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                </td>
                            `;
                        });
                    }

                    this.addActivityEventListeners();
                },

                loadCompletedActivities: function() {
                    const table = document.getElementById('completedActivitiesTable');
                    if (!table) return;

                    const tbody = table.querySelector('tbody');
                    tbody.innerHTML = '';

                    const completed = db.activities
                        .filter(a => a.status === 'completed')
                        .sort((a, b) => new Date(b.endDate || b.startDate) - new Date(a.endDate || a.startDate));

                    if (completed.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="empty-state">
                                        <i class="bi bi-check-circle"></i>
                                        <p>No completed activities</p>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        completed.forEach(activity => {
                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td data-label="Activity">${Utils.sanitizeHTML(activity.title)}</td>
                                <td data-label="Type">${this.formatActivityType(activity.type)}</td>
                                <td data-label="Completed">${Utils.formatDateTime(activity.endDate || activity.startDate)}</td>
                                <td data-label="Location">${Utils.sanitizeHTML(activity.location)}</td>
                                <td data-label="Assigned To">${Utils.sanitizeHTML(activity.assignedTo)}</td>
                                <td data-label="Status">
                                    <span class="badge bg-success">Completed</span>
                                </td>
                                <td data-label="Actions">
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-outline-primary view-activity" data-id="${activity.id}">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                </td>
                            `;
                        });
                    }

                    this.addActivityEventListeners();
                },

                loadOverdueActivities: function() {
                    const table = document.getElementById('overdueActivitiesTable');
                    if (!table) return;

                    const tbody = table.querySelector('tbody');
                    tbody.innerHTML = '';

                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    const overdue = db.activities
                        .filter(a => (a.status === 'planned' || a.status === 'in-progress') && new Date(a.startDate) < today)
                        .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

                    if (overdue.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="empty-state">
                                        <i class="bi bi-exclamation-triangle"></i>
                                        <p>No overdue activities</p>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        overdue.forEach(activity => {
                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td data-label="Activity">${Utils.sanitizeHTML(activity.title)}</td>
                                <td data-label="Type">${this.formatActivityType(activity.type)}</td>
                                <td data-label="Due Date">${Utils.formatDateTime(activity.startDate)}</td>
                                <td data-label="Location">${Utils.sanitizeHTML(activity.location)}</td>
                                <td data-label="Assigned To">${Utils.sanitizeHTML(activity.assignedTo)}</td>
                                <td data-label="Status"><span class="badge bg-danger">Overdue</span></td>
                                <td data-label="Actions">
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-outline-primary view-activity" data-id="${activity.id}">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                </td>
                            `;
                        });
                    }

                    this.addActivityEventListeners();
                },

                addActivityEventListeners: function() {
                    document.querySelectorAll('.view-activity').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const id = parseInt(btn.dataset.id);
                            const activity = db.activities.find(a => a.id === id);
                            if (activity) this.showActivityDetails(activity);
                        });
                    });
                },

                saveActivity: function() {
                    const form = document.getElementById('formNewActivity');
                    if (!form.checkValidity()) {
                        form.classList.add('was-validated');
                        return;
                    }

                    const newActivity = {
                        id: Utils.generateId(),
                        type: document.getElementById('activityType').value,
                        title: document.getElementById('activityTitle').value,
                        startDate: document.getElementById('activityStartDate').value,
                        endDate: document.getElementById('activityEndDate').value || null,
                        location: document.getElementById('activityLocation').value,
                        description: document.getElementById('activityDescription').value,
                        assignedTo: document.getElementById('activityAssignedTo').value,
                        priority: document.getElementById('activityPriority').value,
                        status: document.getElementById('activityStatus').value,
                        notes: document.getElementById('activityNotes').value,
                        createdAt: new Date().toISOString()
                    };

                    db.activities.push(newActivity);
                    
                    if (Utils.saveData()) {
                        form.reset();
                        form.classList.remove('was-validated');
                        
                        bootstrap.Modal.getInstance(document.getElementById('modalNewActivity')).hide();
                        Utils.showToast('Success', 'Activity saved successfully!');
                        
                        this.loadActivities();
                        if (window.calendar) {
                            window.calendar.refetchEvents();
                        }
                        this.loadDashboard();
                    }
                },

                showActivityDetails: function(activity) {
                    const modalBody = document.getElementById('activityModalBody');
                    if (!modalBody) return;

                    modalBody.innerHTML = `
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Activity Type</h6>
                                <p>${this.formatActivityType(activity.type)}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Title</h6>
                                <p>${Utils.sanitizeHTML(activity.title)}</p>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Start Date</h6>
                                <p>${Utils.formatDateTime(activity.startDate)}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>${activity.status === 'completed' ? 'Completed' : 'End'} Date</h6>
                                <p>${activity.endDate ? Utils.formatDateTime(activity.endDate) : 'Not specified'}</p>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Location</h6>
                                <p>${Utils.sanitizeHTML(activity.location)}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Assigned To</h6>
                                <p>${Utils.sanitizeHTML(activity.assignedTo)}</p>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Priority</h6>
                                <span class="badge ${activity.priority === 'high' ? 'bg-danger' : activity.priority === 'medium' ? 'bg-warning' : 'bg-info'}">
                                    ${Utils.capitalize(activity.priority)}
                                </span>
                            </div>
                            <div class="col-md-6">
                                <h6>Status</h6>
                                <span class="badge ${this.getStatusBadgeClass(activity.status)}">${Utils.capitalize(activity.status)}</span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Description</h6>
                            <p>${Utils.sanitizeHTML(activity.description)}</p>
                        </div>
                        
                        ${activity.notes ? `
                        <div class="mb-3">
                            <h6>Notes</h6>
                            <p>${Utils.sanitizeHTML(activity.notes)}</p>
                        </div>
                        ` : ''}
                        
                        <div class="mb-3">
                            <h6>Record Created</h6>
                            <p>${Utils.formatDateTime(activity.createdAt)}</p>
                        </div>
                    `;

                    // Setup complete button
                    const completeBtn = document.getElementById('completeActivityBtn');
                    if (completeBtn) {
                        if (activity.status === 'completed') {
                            completeBtn.style.display = 'none';
                        } else {
                            completeBtn.style.display = 'inline-block';
                            completeBtn.onclick = () => this.completeActivity(activity.id);
                        }
                    }

                    new bootstrap.Modal(document.getElementById('modalViewActivity')).show();
                },

                completeActivity: function(activityId) {
                    const activity = db.activities.find(a => a.id === activityId);
                    if (activity) {
                        activity.status = 'completed';
                        activity.endDate = new Date().toISOString();
                        
                        if (Utils.saveData()) {
                            bootstrap.Modal.getInstance(document.getElementById('modalViewActivity')).hide();
                            Utils.showToast('Success', 'Activity marked as completed!');
                            
                            this.loadActivities();
                            if (window.calendar) {
                                window.calendar.refetchEvents();
                            }
                            this.loadDashboard();
                        }
                    }
                },

                formatActivityType: function(type) {
                    const formats = {
                        'weed-control': 'Weed Control',
                        'revegetation': 'Revegetation',
                        'erosion-control': 'Erosion Control',
                        'fauna-survey': 'Fauna Survey',
                        'vegetation-survey': 'Vegetation Survey',
                        'water-quality': 'Water Quality'
                    };
                    return formats[type] || Utils.capitalize(type);
                },

                getStatusBadgeClass: function(status) {
                    const classes = {
                        'completed': 'bg-success',
                        'in-progress': 'bg-info',
                        'planned': 'bg-primary',
                        'cancelled': 'bg-secondary'
                    };
                    return classes[status] || 'bg-secondary';
                },

                // ==================== MONITORING FUNCTIONS ====================
                loadMonitoring: function() {
                    const table = document.getElementById('monitoringTable');
                    if (!table) return;

                    const tbody = table.querySelector('tbody');
                    tbody.innerHTML = '';

                    if (db.monitoring.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="empty-state">
                                        <i class="bi bi-binoculars"></i>
                                        <p>No monitoring activities recorded yet</p>
                                        <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#modalNewMonitoring">
                                            Add First Monitoring
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        db.monitoring.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(monitoring => {
                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td data-label="Date">${Utils.formatDate(monitoring.date)}</td>
                                <td data-label="Type">${this.formatMonitoringType(monitoring.type)}</td>
                                <td data-label="Location">${Utils.sanitizeHTML(monitoring.location)}</td>
                                <td data-label="Observer">${Utils.sanitizeHTML(monitoring.observer)}</td>
                                <td data-label="Findings">${Utils.sanitizeHTML(monitoring.findings.substring(0, 50))}${monitoring.findings.length > 50 ? '...' : ''}</td>
                                <td data-label="Actions">
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-outline-primary view-monitoring" data-id="${monitoring.id}">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                </td>
                            `;
                        });
                    }

                    document.querySelectorAll('.view-monitoring').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const id = parseInt(btn.dataset.id);
                            const monitoring = db.monitoring.find(m => m.id === id);
                            if (monitoring) this.showMonitoringDetails(monitoring);
                        });
                    });
                },

                saveMonitoring: function() {
                    const form = document.getElementById('formNewMonitoring');
                    if (!form.checkValidity()) {
                        form.classList.add('was-validated');
                        return;
                    }

                    const species = Array.from(document.getElementById('monitoringSpecies').selectedOptions)
                        .map(opt => parseInt(opt.value));

                    const newMonitoring = {
                        id: Utils.generateId(),
                        type: document.getElementById('monitoringType').value,
                        date: document.getElementById('monitoringDate').value,
                        location: document.getElementById('monitoringLocation').value,
                        observer: document.getElementById('monitoringObserver').value,
                        findings: document.getElementById('monitoringFindings').value,
                        species: species,
                        photos: [], // Would handle file uploads
                        notes: document.getElementById('monitoringNotes').value,
                        createdAt: new Date().toISOString()
                    };

                    db.monitoring.push(newMonitoring);
                    
                    if (Utils.saveData()) {
                        form.reset();
                        form.classList.remove('was-validated');
                        document.getElementById('monitoringPhotoPreview').innerHTML = '';
                        
                        bootstrap.Modal.getInstance(document.getElementById('modalNewMonitoring')).hide();
                        Utils.showToast('Success', 'Monitoring record saved successfully!');
                        
                        this.loadMonitoring();
                        this.loadDashboard();
                    }
                },

                showMonitoringDetails: function(monitoring) {
                    const modalBody = document.getElementById('monitoringModalBody');
                    if (!modalBody) return;

                    const speciesNames = monitoring.species.map(id => {
                        const s = db.species.find(sp => sp.id === id);
                        return s ? `${s.scientificName}${s.commonName ? ` (${s.commonName})` : ''}` : 'Unknown species';
                    });

                    modalBody.innerHTML = `
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Monitoring Type</h6>
                                <p>${this.formatMonitoringType(monitoring.type)}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Date</h6>
                                <p>${Utils.formatDate(monitoring.date)}</p>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Location</h6>
                                <p>${Utils.sanitizeHTML(monitoring.location)}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Observer</h6>
                                <p>${Utils.sanitizeHTML(monitoring.observer)}</p>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Findings</h6>
                            <p>${Utils.sanitizeHTML(monitoring.findings)}</p>
                        </div>
                        
                        ${speciesNames.length > 0 ? `
                        <div class="mb-3">
                            <h6>Species Observed</h6>
                            <ul class="list-unstyled">
                                ${speciesNames.map(name => `<li><i class="bi bi-check-circle-fill text-success me-2"></i>${Utils.sanitizeHTML(name)}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                        
                        ${monitoring.notes ? `
                        <div class="mb-3">
                            <h6>Notes</h6>
                            <p>${Utils.sanitizeHTML(monitoring.notes)}</p>
                        </div>
                        ` : ''}
                        
                        <div class="mb-3">
                            <h6>Record Created</h6>
                            <p>${Utils.formatDateTime(monitoring.createdAt)}</p>
                        </div>
                    `;

                    new bootstrap.Modal(document.getElementById('modalViewMonitoring')).show();
                },

                formatMonitoringType: function(type) {
                    const formats = {
                        'fauna-survey': 'Fauna Survey',
                        'vegetation-survey': 'Vegetation Survey',
                        'water-quality': 'Water Quality Testing',
                        'weed-mapping': 'Weed Mapping',
                        'erosion-monitoring': 'Erosion Monitoring'
                    };
                    return formats[type] || Utils.capitalize(type);
                },

                // ==================== REPORT FUNCTIONS ====================
                loadReports: function() {
                    const table = document.getElementById('reportsTable');
                    if (!table) return;

                    const tbody = table.querySelector('tbody');
                    tbody.innerHTML = '';

                    if (db.reports.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center">
                                    <div class="empty-state">
                                        <i class="bi bi-file-earmark-text"></i>
                                        <p>No reports generated yet</p>
                                        <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#modalGenerateReport">
                                            Generate First Report
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        db.reports.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(report => {
                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td data-label="Date">${Utils.formatDate(report.date)}</td>
                                <td data-label="Report Type">${this.formatReportType(report.type)}</td>
                                <td data-label="Generated By">${Utils.sanitizeHTML(report.generatedBy)}</td>
                                <td data-label="Period">${report.period || 'N/A'}</td>
                                <td data-label="Actions">
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-outline-primary view-report" data-id="${report.id}">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary download-report" data-id="${report.id}">
                                            <i class="bi bi-download"></i>
                                        </button>
                                    </div>
                                </td>
                            `;
                        });
                    }

                    document.querySelectorAll('.view-report').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const id = parseInt(btn.dataset.id);
                            const report = db.reports.find(r => r.id === id);
                            if (report) this.showReportDetails(report);
                        });
                    });

                    document.querySelectorAll('.download-report').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const id = parseInt(btn.dataset.id);
                            const report = db.reports.find(r => r.id === id);
                            if (report) this.downloadReport(report);
                        });
                    });
                },

                generateReport: function(type) {
                    const reportTypes = {
                        'compliance': 'Compliance Report',
                        'maintenance': 'Maintenance Summary',
                        'monitoring': 'Monitoring Summary',
                        'health-trend': 'Ecosystem Health Trend',
                        'threat-management': 'Threat Management'
                    };

                    const newReport = {
                        id: Utils.generateId(),
                        type: type,
                        date: new Date().toISOString(),
                        generatedBy: db.settings.userProfile.name,
                        period: 'All time',
                        content: {
                            title: reportTypes[type],
                            body: `Report generated for ${db.settings.siteName}`,
                            data: type === 'maintenance' ? db.activities : 
                                  type === 'monitoring' ? db.monitoring :
                                  type === 'health-trend' ? db.assessments :
                                  type === 'threat-management' ? db.complianceChecklist : [],
                            progress: type === 'compliance' ? 
                                Math.round((db.complianceChecklist.filter(item => item.compliant === 'Yes').length / db.complianceChecklist.length) * 100) : null,
                            checklist: type === 'compliance' ? db.complianceChecklist : []
                        },
                        format: 'pdf',
                        createdAt: new Date().toISOString()
                    };

                    db.reports.push(newReport);
                    
                    if (Utils.saveData()) {
                        Utils.showToast('Success', `${reportTypes[type]} generated successfully!`);
                        this.loadReports();
                        this.showReportDetails(newReport);
                    }
                },

                generateReportFromModal: function() {
                    const type = document.getElementById('reportType').value;
                    if (!type) {
                        document.getElementById('reportType').classList.add('is-invalid');
                        return;
                    }

                    const startDate = document.getElementById('reportStartDate').value;
                    const endDate = document.getElementById('reportEndDate').value;
                    const format = document.getElementById('reportFormat').value;

                    const reportTypes = {
                        'compliance': 'Compliance Report',
                        'maintenance': 'Maintenance Summary',
                        'monitoring': 'Monitoring Summary',
                        'health-trend': 'Ecosystem Health Trend',
                        'threat-management': 'Threat Management'
                    };

                    // Filter data by date if provided
                    let data = [];
                    if (startDate && endDate) {
                        const start = new Date(startDate);
                        const end = new Date(endDate);
                        
                        if (type === 'maintenance') {
                            data = db.activities.filter(a => {
                                const date = new Date(a.startDate);
                                return date >= start && date <= end;
                            });
                        } else if (type === 'monitoring') {
                            data = db.monitoring.filter(m => {
                                const date = new Date(m.date);
                                return date >= start && date <= end;
                            });
                        } else if (type === 'health-trend') {
                            data = db.assessments.filter(a => {
                                const date = new Date(a.date);
                                return date >= start && date <= end;
                            });
                        }
                    }

                    const newReport = {
                        id: Utils.generateId(),
                        type: type,
                        date: new Date().toISOString(),
                        generatedBy: db.settings.userProfile.name,
                        period: startDate && endDate ? `${Utils.formatDate(startDate)} to ${Utils.formatDate(endDate)}` : 'All time',
                        content: {
                            title: reportTypes[type],
                            body: `Report generated for ${db.settings.siteName}`,
                            data: data.length > 0 ? data : 
                                  type === 'maintenance' ? db.activities : 
                                  type === 'monitoring' ? db.monitoring :
                                  type === 'health-trend' ? db.assessments :
                                  type === 'threat-management' ? db.complianceChecklist : [],
                            progress: type === 'compliance' ? 
                                Math.round((db.complianceChecklist.filter(item => item.compliant === 'Yes').length / db.complianceChecklist.length) * 100) : null,
                            checklist: type === 'compliance' ? db.complianceChecklist : []
                        },
                        format: format,
                        createdAt: new Date().toISOString()
                    };

                    db.reports.push(newReport);
                    
                    if (Utils.saveData()) {
                        bootstrap.Modal.getInstance(document.getElementById('modalGenerateReport')).hide();
                        
                        // Generate in selected format
                        if (format === 'pdf') {
                            this.generatePDFReport(newReport);
                        } else if (format === 'excel') {
                            this.generateExcelReport(newReport);
                        } else {
                            this.generateWordReport(newReport);
                        }
                        
                        Utils.showToast('Success', `${reportTypes[type]} generated successfully!`);
                        this.loadReports();
                    }
                },

                generatePDFReport: function(report) {
                    try {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF();
                        
                        // Title
                        doc.setFontSize(20);
                        doc.setTextColor(44, 62, 80);
                        doc.text(report.content.title, 20, 20);
                        
                        // Metadata
                        doc.setFontSize(11);
                        doc.setTextColor(100, 100, 100);
                        doc.text(`Generated: ${Utils.formatDateTime(report.date)}`, 20, 35);
                        doc.text(`By: ${report.generatedBy}`, 20, 42);
                        doc.text(`Site: ${db.settings.siteName}`, 20, 49);
                        doc.text(`Period: ${report.period}`, 20, 56);
                        
                        let yPos = 70;
                        
                        // Content based on type
                        if (report.type === 'compliance' && report.content.checklist) {
                            doc.setFontSize(14);
                            doc.setTextColor(44, 62, 80);
                            doc.text('Compliance Summary', 20, yPos);
                            yPos += 10;
                            
                            // Progress bar representation
                            if (report.content.progress !== null) {
                                doc.setFillColor(200, 200, 200);
                                doc.rect(20, yPos, 170, 8, 'F');
                                doc.setFillColor(40, 167, 69);
                                doc.rect(20, yPos, (170 * report.content.progress) / 100, 8, 'F');
                                doc.setFontSize(10);
                                doc.text(`Compliance: ${report.content.progress}%`, 25, yPos + 6);
                                yPos += 15;
                            }
                            
                            // AutoTable is loaded via the plugin
                            if (doc.autoTable) {
                                doc.autoTable({
                                    startY: yPos,
                                    head: [['Requirement', 'Status', 'Evidence']],
                                    body: report.content.checklist.map(item => [
                                        item.requirement,
                                        item.compliant || 'Not assessed',
                                        item.evidence || 'None'
                                    ]),
                                    theme: 'grid',
                                    styles: { fontSize: 9 },
                                    headStyles: { fillColor: [52, 152, 219] }
                                });
                            }
                        } else {
                            doc.setFontSize(12);
                            doc.setTextColor(80, 80, 80);
                            doc.text(report.content.body, 20, yPos);
                        }
                        
                        doc.save(`report-${report.type}-${new Date().toISOString().split('T')[0]}.pdf`);
                        
                    } catch (error) {
                        console.error('PDF generation error:', error);
                        Utils.showToast('Error', 'Failed to generate PDF', 'error');
                    }
                },

                generateExcelReport: function(report) {
                    try {
                        if (typeof XLSX === 'undefined') {
                            Utils.showToast('Error', 'Excel library not loaded', 'error');
                            return;
                        }

                        const wb = XLSX.utils.book_new();
                        
                        if (report.type === 'compliance') {
                            const data = [
                                ['Compliance Report'],
                                ['Generated:', Utils.formatDateTime(report.date), 'By:', report.generatedBy],
                                ['Site:', db.settings.siteName, 'Period:', report.period],
                                [],
                                ['Requirement', 'Status', 'Evidence', 'Notes']
                            ];
                            
                            report.content.checklist.forEach(item => {
                                data.push([
                                    item.requirement,
                                    item.compliant || 'Not assessed',
                                    item.evidence || 'None',
                                    item.notes || ''
                                ]);
                            });
                            
                            const ws = XLSX.utils.aoa_to_sheet(data);
                            XLSX.utils.book_append_sheet(wb, ws, 'Compliance');
                            
                        } else if (report.type === 'maintenance') {
                            const data = [
                                ['Maintenance Activities Report'],
                                ['Generated:', Utils.formatDateTime(report.date), 'By:', report.generatedBy],
                                ['Site:', db.settings.siteName, 'Period:', report.period],
                                [],
                                ['Title', 'Type', 'Date', 'Status', 'Assigned To', 'Location', 'Priority']
                            ];
                            
                            (report.content.data || db.activities).forEach(activity => {
                                data.push([
                                    activity.title,
                                    this.formatActivityType(activity.type),
                                    Utils.formatDateTime(activity.startDate),
                                    Utils.capitalize(activity.status),
                                    activity.assignedTo,
                                    activity.location,
                                    Utils.capitalize(activity.priority)
                                ]);
                            });
                            
                            const ws = XLSX.utils.aoa_to_sheet(data);
                            XLSX.utils.book_append_sheet(wb, ws, 'Maintenance');
                        }
                        
                        XLSX.writeFile(wb, `report-${report.type}-${new Date().toISOString().split('T')[0]}.xlsx`);
                        
                    } catch (error) {
                        console.error('Excel generation error:', error);
                        Utils.showToast('Error', 'Failed to generate Excel file', 'error');
                    }
                },

                generateWordReport: function(report) {
                    try {
                        const html = `
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <meta charset="UTF-8">
                                <title>${report.content.title}</title>
                                <style>
                                    body { font-family: Arial, sans-serif; margin: 40px; }
                                    h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
                                    .metadata { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0; }
                                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                                    th { background-color: #3498db; color: white; }
                                    .progress-bar { background: #ecf0f1; height: 20px; border-radius: 10px; margin: 10px 0; }
                                    .progress-fill { background: #27ae60; height: 100%; border-radius: 10px; }
                                </style>
                            </head>
                            <body>
                                <h1>${report.content.title}</h1>
                                
                                <div class="metadata">
                                    <p><strong>Generated:</strong> ${Utils.formatDateTime(report.date)}</p>
                                    <p><strong>By:</strong> ${report.generatedBy}</p>
                                    <p><strong>Site:</strong> ${db.settings.siteName}</p>
                                    <p><strong>Period:</strong> ${report.period}</p>
                                </div>
                                
                                ${report.type === 'compliance' && report.content.checklist ? `
                                    <h2>Compliance Summary</h2>
                                    ${report.content.progress !== null ? `
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: ${report.content.progress}%"></div>
                                        </div>
                                        <p>Overall Compliance: ${report.content.progress}%</p>
                                    ` : ''}
                                    
                                    <table>
                                        <tr>
                                            <th>Requirement</th>
                                            <th>Status</th>
                                            <th>Evidence</th>
                                        </tr>
                                        ${report.content.checklist.map(item => `
                                            <tr>
                                                <td>${item.requirement}</td>
                                                <td>${item.compliant || 'Not assessed'}</td>
                                                <td>${item.evidence || 'None'}</td>
                                            </tr>
                                        `).join('')}
                                    </table>
                                ` : ''}
                            </body>
                            </html>
                        `;
                        
                        const blob = new Blob([html], { type: 'application/msword' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `report-${report.type}-${new Date().toISOString().split('T')[0]}.doc`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        
                    } catch (error) {
                        console.error('Word generation error:', error);
                        Utils.showToast('Error', 'Failed to generate Word document', 'error');
                    }
                },

                downloadReport: function(report) {
                    if (report.format === 'pdf') {
                        this.generatePDFReport(report);
                    } else if (report.format === 'excel') {
                        this.generateExcelReport(report);
                    } else {
                        this.generateWordReport(report);
                    }
                },

                showReportDetails: function(report) {
                    const modalBody = document.getElementById('reportModalBody');
                    if (!modalBody) return;

                    let html = `
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Report Type</h6>
                                <p>${this.formatReportType(report.type)}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Generated On</h6>
                                <p>${Utils.formatDateTime(report.date)}</p>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Generated By</h6>
                                <p>${Utils.sanitizeHTML(report.generatedBy)}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Period</h6>
                                <p>${report.period || 'N/A'}</p>
                            </div>
                        </div>
                        
                        <h4 class="mb-3">${report.content.title}</h4>
                        <p class="mb-4">${report.content.body}</p>
                    `;

                    if (report.type === 'compliance' && report.content.checklist) {
                        html += `
                            <div class="mb-3">
                                <h5>Compliance Progress: ${report.content.progress}%</h5>
                                <div class="progress">
                                    <div class="progress-bar bg-success" style="width: ${report.content.progress}%">
                                        ${report.content.progress}%
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Requirement</th>
                                            <th>Status</th>
                                            <th>Evidence</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${report.content.checklist.map(item => `
                                            <tr>
                                                <td>${Utils.sanitizeHTML(item.requirement)}</td>
                                                <td>${item.compliant || 'Not assessed'}</td>
                                                <td>${item.evidence || 'None'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }

                    if (report.type === 'maintenance' && report.content.data) {
                        html += `
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Activity</th>
                                            <th>Type</th>
                                            <th>Date</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${report.content.data.slice(0, 10).map(activity => `
                                            <tr>
                                                <td>${Utils.sanitizeHTML(activity.title)}</td>
                                                <td>${this.formatActivityType(activity.type)}</td>
                                                <td>${Utils.formatDate(activity.startDate)}</td>
                                                <td>${Utils.capitalize(activity.status)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                ${report.content.data.length > 10 ? `<p>... and ${report.content.data.length - 10} more items</p>` : ''}
                            </div>
                        `;
                    }

                    modalBody.innerHTML = html;
                    
                    const downloadBtn = document.getElementById('downloadReportBtn');
                    downloadBtn.onclick = () => this.downloadReport(report);
                    
                    new bootstrap.Modal(document.getElementById('modalViewReport')).show();
                },

                formatReportType: function(type) {
                    const formats = {
                        'compliance': 'Compliance Report',
                        'maintenance': 'Maintenance Summary',
                        'monitoring': 'Monitoring Summary',
                        'health-trend': 'Ecosystem Health Trend',
                        'threat-management': 'Threat Management'
                    };
                    return formats[type] || Utils.capitalize(type);
                },

                // ==================== COMPLIANCE FUNCTIONS ====================
                loadComplianceChecklist: function() {
                    const table = document.getElementById('complianceChecklistTable');
                    if (!table) return;

                    const tbody = table.querySelector('tbody');
                    tbody.innerHTML = '';

                    db.complianceChecklist.forEach(item => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${Utils.sanitizeHTML(item.requirement)}</td>
                            <td>
                                <select class="form-select form-select-sm compliance-status" data-id="${item.id}">
                                    <option value="" ${item.compliant === '' ? 'selected' : ''}>Select...</option>
                                    <option value="Yes" ${item.compliant === 'Yes' ? 'selected' : ''}>Yes</option>
                                    <option value="No" ${item.compliant === 'No' ? 'selected' : ''}>No</option>
                                    <option value="Partial" ${item.compliant === 'Partial' ? 'selected' : ''}>Partial</option>
                                </select>
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm compliance-evidence" 
                                       data-id="${item.id}" value="${Utils.sanitizeHTML(item.evidence || '')}" 
                                       placeholder="Document reference">
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary compliance-note" data-id="${item.id}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </td>
                        `;
                    });

                    // Add note functionality (simplified)
                    document.querySelectorAll('.compliance-note').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const id = parseInt(btn.dataset.id);
                            const note = prompt('Enter note:');
                            if (note !== null) {
                                const item = db.complianceChecklist.find(i => i.id === id);
                                if (item) {
                                    item.notes = note;
                                    Utils.saveData();
                                    Utils.showToast('Success', 'Note saved');
                                }
                            }
                        });
                    });
                },

                saveComplianceChecklist: function() {
                    document.querySelectorAll('.compliance-status').forEach(select => {
                        const id = parseInt(select.dataset.id);
                        const item = db.complianceChecklist.find(i => i.id === id);
                        if (item) item.compliant = select.value;
                    });

                    document.querySelectorAll('.compliance-evidence').forEach(input => {
                        const id = parseInt(input.dataset.id);
                        const item = db.complianceChecklist.find(i => i.id === id);
                        if (item) item.evidence = input.value;
                    });

                    if (Utils.saveData()) {
                        Utils.showToast('Success', 'Compliance checklist saved');
                        this.loadDashboard();
                    }
                },

                // ==================== SETTINGS FUNCTIONS ====================
                loadSettings: function() {
                    // User profile
                    document.getElementById('settingsUserName').value = db.settings.userProfile.name || '';
                    document.getElementById('settingsUserEmail').value = db.settings.userProfile.email || '';
                    document.getElementById('settingsUserRole').value = db.settings.userProfile.role || '';

                    // Site settings
                    document.getElementById('settingsSiteName').value = db.settings.siteName || '';
                    document.getElementById('settingsSiteLocation').value = db.settings.siteLocation || '';
                    document.getElementById('settingsSiteArea').value = db.settings.siteArea || '';
                    document.getElementById('settingsSiteDescription').value = db.settings.siteDescription || '';
                },

                saveUserProfile: function(e) {
                    e.preventDefault();
                    const form = document.getElementById('settingsUserProfileForm');
                    
                    if (!form.checkValidity()) {
                        form.classList.add('was-validated');
                        return;
                    }

                    db.settings.userProfile = {
                        name: document.getElementById('settingsUserName').value,
                        email: document.getElementById('settingsUserEmail').value,
                        role: document.getElementById('settingsUserRole').value
                    };

                    if (Utils.saveData()) {
                        Utils.showToast('Success', 'Profile updated');
                        form.classList.remove('was-validated');
                    }
                },

                saveSiteSettings: function(e) {
                    e.preventDefault();
                    const form = document.getElementById('settingsSiteForm');
                    
                    if (!form.checkValidity()) {
                        form.classList.add('was-validated');
                        return;
                    }

                    db.settings.siteName = document.getElementById('settingsSiteName').value;
                    db.settings.siteLocation = document.getElementById('settingsSiteLocation').value;
                    db.settings.siteArea = parseFloat(document.getElementById('settingsSiteArea').value);
                    db.settings.siteDescription = document.getElementById('settingsSiteDescription').value;

                    if (Utils.saveData()) {
                        Utils.showToast('Success', 'Site settings updated');
                        form.classList.remove('was-validated');
                    }
                },

                changePassword: function(e) {
                    e.preventDefault();
                    const form = document.getElementById('settingsPasswordForm');
                    
                    if (!form.checkValidity()) {
                        form.classList.add('was-validated');
                        return;
                    }

                    const newPass = document.getElementById('settingsNewPassword').value;
                    const confirmPass = document.getElementById('settingsConfirmPassword').value;

                    if (newPass !== confirmPass) {
                        document.getElementById('settingsConfirmPassword').classList.add('is-invalid');
                        return;
                    }

                    // In production, this would hash and send to server
                    Utils.showToast('Success', 'Password changed successfully');
                    form.reset();
                    form.classList.remove('was-validated');
                },

                // ==================== DATA MANAGEMENT FUNCTIONS ====================
                exportAllData: function() {
                    const exportData = {
                        assessments: db.assessments,
                        species: db.species,
                        activities: db.activities,
                        monitoring: db.monitoring,
                        reports: db.reports,
                        faunaSightings: db.faunaSightings,
                        vegetationSurveys: db.vegetationSurveys,
                        complianceChecklist: db.complianceChecklist,
                        settings: db.settings,
                        exportDate: new Date().toISOString(),
                        version: '1.0.0'
                    };

                    const dataStr = JSON.stringify(exportData, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ecosystem-data-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);

                    Utils.showToast('Success', 'Data exported successfully');
                },

                backupDatabase: function() {
                    this.exportAllData();
                    localStorage.setItem('lastBackup', new Date().toLocaleString());
                    document.getElementById('lastBackupInfo').textContent = new Date().toLocaleString();
                    Utils.showToast('Info', 'Backup created', 'info');
                },

                resetTestData: function() {
                    Utils.showConfirmation(
                        'Reset Test Data',
                        'Are you sure you want to reset all test data? This will restore the initial sample data and cannot be undone.',
                        () => {
                            // Clear existing data
                            localStorage.clear();
                            
                            // Reload initial data
                            this.loadInitialData();
                            
                            // Refresh all views
                            this.loadDashboard();
                            this.loadAssessments();
                            this.loadSpecies();
                            this.loadActivities();
                            this.loadMonitoring();
                            this.loadReports();
                            this.loadComplianceChecklist();
                            this.loadSettings();
                            
                            // Refresh calendar
                            if (window.calendar) {
                                window.calendar.refetchEvents();
                            }
                            
                            // Refresh map (reinitialize)
                            if (window.map) {
                                window.map.remove();
                                this.initMap();
                            }
                            
                            Utils.showToast('Success', 'Test data has been reset');
                        }
                    );
                },

                // ==================== EVENT LISTENERS ====================
                setupEventListeners: function() {
                    // Save buttons
                    document.getElementById('saveAssessmentBtn')?.addEventListener('click', () => this.saveAssessment());
                    document.getElementById('saveActivityBtn')?.addEventListener('click', () => this.saveActivity());
                    document.getElementById('saveSpeciesBtn')?.addEventListener('click', () => this.saveSpecies());
                    document.getElementById('saveMonitoringBtn')?.addEventListener('click', () => this.saveMonitoring());
                    document.getElementById('saveFaunaSightingBtn')?.addEventListener('click', () => this.saveFaunaSighting());
                    document.getElementById('saveVegetationSurveyBtn')?.addEventListener('click', () => this.saveVegetationSurvey());
                    document.getElementById('saveComplianceBtn')?.addEventListener('click', () => this.saveComplianceChecklist());
                    document.getElementById('generateReportBtn')?.addEventListener('click', () => this.generateReportFromModal());

                    // Form submissions
                    document.getElementById('settingsUserProfileForm')?.addEventListener('submit', (e) => this.saveUserProfile(e));
                    document.getElementById('settingsSiteForm')?.addEventListener('submit', (e) => this.saveSiteSettings(e));
                    document.getElementById('settingsPasswordForm')?.addEventListener('submit', (e) => this.changePassword(e));

                    // Data management buttons
                    document.getElementById('exportAllDataBtn')?.addEventListener('click', () => this.exportAllData());
                    document.getElementById('backupDatabaseBtn')?.addEventListener('click', () => this.backupDatabase());
                    document.getElementById('resetTestDataBtn')?.addEventListener('click', () => this.resetTestData());

                    // Export/Print buttons
                    document.getElementById('exportDashboardBtn')?.addEventListener('click', () => this.exportAllData());
                    document.getElementById('printDashboardBtn')?.addEventListener('click', () => window.print());
                    document.getElementById('exportSpeciesBtn')?.addEventListener('click', () => this.exportAllData());
                    document.getElementById('printSpeciesBtn')?.addEventListener('click', () => window.print());

                    // View all buttons
                    document.getElementById('viewAllFaunaBtn')?.addEventListener('click', () => {
                        document.querySelector('button[data-bs-target="#monitoring"]')?.click();
                    });
                    document.getElementById('viewAllVegetationBtn')?.addEventListener('click', () => {
                        document.querySelector('button[data-bs-target="#monitoring"]')?.click();
                    });

                    // Print buttons in modals
                    document.getElementById('printAssessmentBtn')?.addEventListener('click', () => window.print());
                    document.getElementById('printSpeciesDetailsBtn')?.addEventListener('click', () => window.print());
                    document.getElementById('printActivityBtn')?.addEventListener('click', () => window.print());
                    document.getElementById('printMonitoringBtn')?.addEventListener('click', () => window.print());

                    // Generate compliance report
                    document.getElementById('generateComplianceReportBtn')?.addEventListener('click', () => this.generateReport('compliance'));

                    // Tab change events
                    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                        tab.addEventListener('shown.bs.tab', (e) => {
                            const target = e.target.getAttribute('data-bs-target');
                            
                            if (target === '#dashboard') {
                                this.loadDashboard();
                            } else if (target === '#site-assessment') {
                                this.loadAssessments();
                            } else if (target === '#maintenance-plan') {
                                this.loadActivities();
                                if (window.calendar) window.calendar.refetchEvents();
                            } else if (target === '#species-register') {
                                this.loadSpecies();
                            } else if (target === '#monitoring') {
                                this.loadMonitoring();
                            } else if (target === '#reports') {
                                this.loadReports();
                            } else if (target === '#legislation') {
                                this.loadComplianceChecklist();
                            } else if (target === '#settings') {
                                this.loadSettings();
                            }
                        });
                    });

                    // Map layer toggles
                    document.getElementById('zoneToggle')?.addEventListener('click', function() {
                        if (window.map && window.zonesLayer) {
                            if (window.map.hasLayer(window.zonesLayer)) {
                                window.map.removeLayer(window.zonesLayer);
                                this.classList.remove('active');
                                this.setAttribute('aria-pressed', 'false');
                            } else {
                                window.map.addLayer(window.zonesLayer);
                                this.classList.add('active');
                                this.setAttribute('aria-pressed', 'true');
                            }
                        }
                    });

                    document.getElementById('vegetationToggle')?.addEventListener('click', function() {
                        if (window.map && window.vegetationLayer) {
                            if (window.map.hasLayer(window.vegetationLayer)) {
                                window.map.removeLayer(window.vegetationLayer);
                                this.classList.remove('active');
                                this.setAttribute('aria-pressed', 'false');
                            } else {
                                window.map.addLayer(window.vegetationLayer);
                                this.classList.add('active');
                                this.setAttribute('aria-pressed', 'true');
                            }
                        }
                    });

                    document.getElementById('weedsToggle')?.addEventListener('click', function() {
                        if (window.map && window.weedsLayer) {
                            if (window.map.hasLayer(window.weedsLayer)) {
                                window.map.removeLayer(window.weedsLayer);
                                this.classList.remove('active');
                                this.setAttribute('aria-pressed', 'false');
                            } else {
                                window.map.addLayer(window.weedsLayer);
                                this.classList.add('active');
                                this.setAttribute('aria-pressed', 'true');
                            }
                        }
                    });

                    // Image preview handlers
                    document.getElementById('speciesImage')?.addEventListener('change', function(e) {
                        const preview = document.getElementById('speciesImagePreview');
                        if (this.files && this.files[0]) {
                            const url = URL.createObjectURL(this.files[0]);
                            preview.src = url;
                            preview.style.display = 'block';
                            
                            // Clean up when modal closes
                            const modal = document.getElementById('modalNewSpecies');
                            modal.addEventListener('hidden.bs.modal', function() {
                                URL.revokeObjectURL(url);
                                preview.style.display = 'none';
                            }, { once: true });
                        }
                    });

                    // Photo previews for multiple files
                    ['assessment', 'monitoring', 'fauna', 'vegetation'].forEach(prefix => {
                        const input = document.getElementById(`${prefix}Photos`);
                        const container = document.getElementById(`${prefix}PhotoPreview`);
                        
                        if (input && container) {
                            input.addEventListener('change', function() {
                                container.innerHTML = '';
                                
                                Array.from(this.files).forEach(file => {
                                    if (file.type.startsWith('image/')) {
                                        const url = URL.createObjectURL(file);
                                        const img = document.createElement('img');
                                        img.src = url;
                                        img.className = 'image-thumbnail';
                                        img.alt = 'Preview';
                                        container.appendChild(img);
                                        
                                        // Clean up when modal closes
                                        const modal = this.closest('.modal');
                                        if (modal) {
                                            modal.addEventListener('hidden.bs.modal', function() {
                                                URL.revokeObjectURL(url);
                                            }, { once: true });
                                        }
                                    }
                                });
                            });
                        }
                    });

                    // Component validation
                    document.querySelectorAll('#formNewAssessment input[name="components"]').forEach(cb => {
                        cb.addEventListener('change', function() {
                            const checked = document.querySelectorAll('#formNewAssessment input[name="components"]:checked');
                            const feedback = document.getElementById('componentsFeedback');
                            if (feedback) {
                                feedback.style.display = checked.length === 0 ? 'block' : 'none';
                            }
                        });
                    });

                    // Modal reset on close
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.addEventListener('hidden.bs.modal', function() {
                            const form = this.querySelector('form');
                            if (form) {
                                form.reset();
                                form.classList.remove('was-validated');
                            }
                            
                            // Clear previews
                            this.querySelectorAll('.image-preview-container').forEach(container => {
                                container.innerHTML = '';
                            });
                            
                            const speciesPreview = this.querySelector('#speciesImagePreview');
                            if (speciesPreview) {
                                speciesPreview.style.display = 'none';
                                speciesPreview.src = '#';
                            }
                            
                            const feedback = this.querySelector('#componentsFeedback');
                            if (feedback) {
                                feedback.style.display = 'none';
                            }
                        });
                    });
                },

                // ==================== FAUNA AND VEGETATION FUNCTIONS ====================
                saveFaunaSighting: function() {
                    const form = document.getElementById('formFaunaSighting');
                    if (!form.checkValidity()) {
                        form.classList.add('was-validated');
                        return;
                    }

                    const newSighting = {
                        id: Utils.generateId(),
                        speciesId: parseInt(document.getElementById('faunaSpecies').value),
                        date: document.getElementById('faunaDate').value,
                        location: document.getElementById('faunaLocation').value,
                        observer: document.getElementById('faunaObserver').value,
                        count: parseInt(document.getElementById('faunaCount').value) || 1,
                        behavior: document.getElementById('faunaBehavior').value,
                        photos: [],
                        notes: document.getElementById('faunaNotes').value,
                        createdAt: new Date().toISOString()
                    };

                    db.faunaSightings.push(newSighting);

                    // Update species last observed
                    const species = db.species.find(s => s.id === newSighting.speciesId);
                    if (species) {
                        species.lastObserved = newSighting.date;
                    }

                    if (Utils.saveData()) {
                        form.reset();
                        form.classList.remove('was-validated');
                        document.getElementById('faunaPhotoPreview').innerHTML = '';
                        
                        bootstrap.Modal.getInstance(document.getElementById('modalFaunaSighting')).hide();
                        Utils.showToast('Success', 'Fauna sighting saved');
                        
                        this.loadSpecies();
                    }
                },

                saveVegetationSurvey: function() {
                    const form = document.getElementById('formVegetationSurvey');
                    if (!form.checkValidity()) {
                        form.classList.add('was-validated');
                        return;
                    }

                    const species = Array.from(document.getElementById('vegetationSpecies').selectedOptions)
                        .map(opt => parseInt(opt.value));

                    const newSurvey = {
                        id: Utils.generateId(),
                        date: document.getElementById('vegetationDate').value,
                        location: document.getElementById('vegetationLocation').value,
                        observer: document.getElementById('vegetationObserver').value,
                        species: species,
                        nativeCover: parseInt(document.getElementById('vegetationCover').value) || 0,
                        weedCover: parseInt(document.getElementById('vegetationWeedCover').value) || 0,
                        health: document.getElementById('vegetationHealth').value,
                        findings: document.getElementById('vegetationFindings').value,
                        photos: [],
                        notes: document.getElementById('vegetationNotes').value,
                        createdAt: new Date().toISOString()
                    };

                    db.vegetationSurveys.push(newSurvey);

                    // Update species last observed
                    species.forEach(id => {
                        const s = db.species.find(sp => sp.id === id);
                        if (s) s.lastObserved = newSurvey.date;
                    });

                    if (Utils.saveData()) {
                        form.reset();
                        form.classList.remove('was-validated');
                        document.getElementById('vegetationPhotoPreview').innerHTML = '';
                        
                        bootstrap.Modal.getInstance(document.getElementById('modalVegetationSurvey')).hide();
                        Utils.showToast('Success', 'Vegetation survey saved');
                        
                        this.loadSpecies();
                    }
                }
            };

            // ==================== INITIALIZE APPLICATION ====================
            document.addEventListener('DOMContentLoaded', function() {
                App.init();
            });

            // Expose global functions for onclick handlers
            window.generateReport = function(type) {
                App.generateReport(type);
            };

        })();
    </script>
</body>
</html>
